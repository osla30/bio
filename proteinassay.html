<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bradford / BCA Protein Assay | ËõãÁôΩË≥™ÂÆöÈáèÂ∑•ÂÖ∑</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-color: #0d6efd; 
            --bg-color: #f4f6f9;
            --text-color: #333;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        body {
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: var(--text-color);
            padding-bottom: 50px;
        }

        .navbar {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-top: 4px solid var(--primary-color);
            padding-top: 10px;
            padding-bottom: 10px;
        }

        .navbar-brand {
            font-weight: bold;
            color: var(--primary-color) !important;
            display: flex;
            align-items: center;
        }

        .badge-engine {
            font-size: 0.7rem;
            background-color: var(--primary-color);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: normal;
            letter-spacing: 0.5px;
        }

        .lang-switch-btn {
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            background: transparent;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .lang-switch-btn:hover, .lang-switch-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* Êñ∞Â¢ûÔºö‰∏ãËºâÊåâÈàïÁöÑÊ®£ÂºèÔºå‰ΩøÂÖ∂ËàáË™ûË®ÄÊåâÈàïÈ¢®Ê†º‰∏ÄËá¥ */
        .download-btn {
            border: 1px solid #6c757d;
            color: #6c757d;
            background: transparent;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }
        .download-btn:hover {
            background-color: #6c757d;
            color: white;
        }

        .nav-action-btn {
            font-weight: 500;
            border-radius: 20px;
            padding: 5px 20px;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .card {
            border: none;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            background-color: white;
        }

        .card-header {
            background-color: white;
            border-bottom: 1px solid #eee;
            font-weight: bold;
            color: var(--primary-color);
            padding: 15px 20px;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start; 
        }

        .card-body {
            padding: 20px;
        }

        .btn-primary-custom {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        .btn-primary-custom:hover { background-color: #0b5ed7; border-color: #0a58ca; color: white; }
        
        .btn-success-custom {
            background-color: #198754;
            border-color: #198754;
            color: white;
        }
        .btn-success-custom:hover { background-color: #157347; border-color: #146c43; color: white; }

        .bulk-input-container {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 5px;
        }

        .bulk-textarea {
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre;
            overflow-x: auto;
            resize: vertical;
            border-color: #ced4da;
        }
        .bulk-textarea:focus {
            background-color: #f8fbff;
            border-color: var(--primary-color);
        }

        .column-header {
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
            margin-bottom: 5px;
            color: #555;
            background-color: #f8f9fa;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .control-row {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .table-result th {
            background-color: #f8f9fa;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #888;
            font-size: 0.85rem;
        }

        .chart-container-wrapper {
            position: relative;
            height: 350px; 
            width: 100%;
        }

        .equation-text {
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--primary-color);
            text-align: right;
            font-weight: bold;
            margin-top: 2px;
        }

        .recipe-input-group label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 2px;
        }
        
        .alert-mini {
            font-size: 0.8rem;
            margin-bottom: 5px;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .text-warning-dark {
            color: #b45309;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand me-auto" href="#">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2"><path d="M2 12h5l3-9 4 18 4-9h4"></path></svg>
                <span data-i18n="title">Bradford / BCA Protein Assay</span>
                <span class="badge-engine">For Western Blot</span>
            </a>

            <div class="position-absolute start-50 translate-middle-x d-flex gap-2">
                <button class="btn btn-primary-custom nav-action-btn" onclick="calculate()" data-i18n="calculate_btn">Calculate Analysis</button>
                <button class="btn btn-success-custom nav-action-btn" onclick="exportExcel()" data-i18n="export_btn">Export Excel</button>
                <button class="btn btn-outline-secondary nav-action-btn" onclick="clearData()" data-i18n="clear_btn">Clear All</button>
            </div>

            <div class="d-flex ms-auto align-items-center">
                <a href="https://drive.google.com/file/d/1HvgRn-5JxICnZJ10wXYT3qNzNu0GsoFE/view?usp=sharing" target="_blank" rel="noopener noreferrer" class="download-btn me-3" download>
                <span class="me-1">üì•</span> 
                <span data-i18n="download_offline">Download Offline</span>
                </a>

                <button class="lang-switch-btn me-2" onclick="setLang('en')">English</button>
                <button class="lang-switch-btn" onclick="setLang('zh')">‰∏≠Êñá</button>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 90px;">
        <div class="row">
            <div class="col-lg-5">
                <div class="card">
                    <div class="card-header" data-i18n="settings_input">Settings & Input</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold" data-i18n="regression_model">Regression Model:</label>
                            <div class="p-2 bg-light border rounded text-primary fw-bold">
                                Linear Regression (y = ax + b)
                            </div>
                            <div class="form-text text-muted mt-2" style="font-size: 0.85rem;" data-i18n="model_hint">
                                BradfordÔºö595nm / BCAÔºö562nm
                            </div>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label fw-bold mb-0" data-i18n="standard_data">Standard Curve Data:</label>
                                <button class="btn btn-sm btn-link p-0 text-decoration-none" onclick="loadDemoData()" data-i18n="load_demo">Load Demo</button>
                            </div>
                            
                            <div class="control-row row g-2">
                                <div class="col-12">
                                    <label class="form-label mb-1 small" data-i18n="replicates">OD Replicates</label>
                                    <select class="form-select form-select-sm" id="stdReplicates" onchange="renderStandardInputs()">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="alert alert-info alert-mini" data-i18n="input_hint">Tip: Ensure no empty lines to prevent misalignment.</div>
                            <div id="stdDataContainer" class="bulk-input-container">
                            </div>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <label class="form-label fw-bold" data-i18n="sample_data">Sample Data (Name & ODs):</label>
                            
                            <div class="control-row row g-2">
                                <div class="col-12">
                                    <label class="form-label mb-1 small" data-i18n="replicates">OD Replicates</label>
                                    <select class="form-select form-select-sm" id="sampleReplicates" onchange="renderSampleInputs()">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                    </select>
                                </div>
                            </div>

                            <div class="alert alert-info alert-mini" data-i18n="input_hint">Tip: Ensure no empty lines to prevent misalignment.</div>
                            <div id="sampleDataContainer" class="bulk-input-container">
                            </div>
                        </div>

                        <div class="mb-2">
                            <label class="form-label fw-bold" data-i18n="dilution_factor">Dilution Factor:</label>
                            <input type="number" class="form-control" id="dilutionFactor" value="1" min="1" step="0.1">
                            <div class="form-text text-muted" data-i18n="dilution_hint">Result concentration will be multiplied by this factor.</div>
                        </div>

                    </div>
                </div>
            </div> 
            
            <div class="col-lg-7">
                <div class="card">
                    <div class="card-header">
                        <span data-i18n="standard_curve">Standard Curve</span>
                        <div id="r2_score" class="equation-text"></div>
                    </div>
                    <div class="card-body">
                        <div id="r2_warning_box" class="alert alert-warning py-1 px-2 mb-2" style="display:none; font-size:0.85rem;"></div>
                        <div class="chart-container-wrapper">
                            <canvas id="elisaChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" data-i18n="calculation_results">Calculation Results</div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-hover table-striped mb-0 table-result">
                                <thead class="sticky-top bg-light" style="z-index: 5;">
                                    <tr>
                                        <th data-i18n="sample_name_col">Sample Name</th>
                                        <th data-i18n="mean_od">Mean OD</th>
                                        <th data-i18n="calc_conc">Concentration</th>
                                        <th data-i18n="status">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="resultTableBody">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted p-4" data-i18n="no_result">No results yet. Click Calculate to start.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card mt-4 border-success" style="border-width: 2px;">
                    <div class="card-header bg-success text-white">
                        <span data-i18n="wb_title">Western Blot Ê®£Êú¨ÈÖçË£ΩË®àÁÆó</span>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 mb-3 bg-light p-3 rounded">
                            <div class="col-md-3 recipe-input-group">
                                <label data-i18n="target_protein">ÁõÆÊ®ôËõãÁôΩÈáè (¬µg)</label>
                                <input type="number" class="form-control" id="wb_mass" value="20" oninput="calculateRecipe()">
                            </div>
                            <div class="col-md-3 recipe-input-group">
                                <label data-i18n="target_vol">ÂñÆÂ≠îÁõÆÊ®ôÈ´îÁ©ç (¬µL)</label>
                                <input type="number" class="form-control" id="wb_vol" value="20" oninput="calculateRecipe()">
                            </div>
                            <div class="col-md-3 recipe-input-group">
                                <label data-i18n="buffer_x">Sample Buffer ÂÄçÊï∏</label>
                                <input type="number" class="form-control" id="wb_buffer" value="4" oninput="calculateRecipe()">
                            </div>
                            <div class="col-md-3 recipe-input-group">
                                <label data-i18n="prep_n">ÈÖçË£Ω‰ªΩÊï∏ (n)</label>
                                <input type="number" class="form-control" id="wb_n" value="2" oninput="calculateRecipe()">
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered table-sm text-center align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th data-i18n="sample_name_col">Ê®£Êú¨ÂêçÁ®±</th>
                                        <th data-i18n="col_prot_vol">ËõãÁôΩÈ´îÁ©ç (¬µL)</th>
                                        <th data-i18n="col_water_vol">ddH2O (¬µL)</th>
                                        <th data-i18n="col_buff_vol">Buffer (¬µL)</th>
                                        <th data-i18n="col_total_vol">Á∏ΩÈ´îÁ©ç (¬µL)</th>
                                    </tr>
                                </thead>
                                <tbody id="recipeTableBody">
                                    <tr>
                                        <td colspan="5" class="text-muted py-3" data-i18n="no_result">
                                            Ë´ãÂÖàÈÄ≤Ë°å‰∏äÊñπË®àÁÆó
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div> 
        </div> 
    </div> 
    
    <script>
        // ==========================================
        //  UI & LOCALIZATION
        // ==========================================
        const i18n = {
            en: {
                title: "Bradford / BCA Protein Assay",
                settings_input: "Settings & Input",
                regression_model: "Regression Model:",
                standard_data: "Standard Curve Data:",
                load_demo: "Load Demo",
                sample_data: "Sample Data (Name & ODs):",
                input_hint: "Tip: Ensure no empty lines between data to prevent misalignment.",
                replicates: "Replicates",
                dilution_factor: "Dilution Factor:",
                dilution_hint: "Result concentration will be multiplied by this factor. (Calculated based on standard)",
                calculate_btn: "Calculate",
                export_btn: "Export Excel",
                clear_btn: "Clear All",
                standard_curve: "Standard Curve",
                calculation_results: "Results",
                calc_conc: "Concentration (Œºg/ŒºL)",
                status: "Note",
                no_result: "No results yet. Click Calculate to start.",
                model_hint: "Bradford: 595nm / BCA: 562nm",
                conc_lbl: "Conc (Œºg/ŒºL)",
                od_lbl: "Absorbance (OD)",
                ph_col: "Paste column...",
                no_calc_alert: "Please calculate first.",
                sample_name_input: "Sample Name",
                sample_name_col: "Sample Name",
                sample_od: "Sample OD",
                mean_od: "Mean OD",
                download_offline: "Download Offline", // Êñ∞Â¢û
                // Western Blot Translations
                wb_title: "Western Blot Recipe Calculator",
                target_protein: "Target Mass (¬µg)",
                target_vol: "Target Vol (per well, ¬µL)",
                buffer_x: "Sample Buffer Conc. (X)",
                prep_n: "Replicates (n)",
                col_prot_vol: "Protein Vol (¬µL)",
                col_water_vol: "ddH2O Vol (¬µL)",
                col_buff_vol: "Buffer Vol (¬µL)",
                col_total_vol: "Total Vol (¬µL)",
                r2_warning: "Warning: R¬≤ < 0.98. The linearity is poor, results may be inaccurate.",
                note_high: "Extrapolated (High)",
                note_low: "Extrapolated (Low)",
                note_neg: "Out of Range",
                err_buff_x: "Error: Buffer X < 1"
            },
            zh: {
                title: "Bradford / BCA ËõãÁôΩË≥™ÂÆöÈáèÂ∑•ÂÖ∑",
                settings_input: "Ë®≠ÂÆöËàáËº∏ÂÖ•",
                regression_model: "ÂõûÊ≠∏Ê®°Âûã:",
                standard_data: "Ê®ôÊ∫ñÂìÅÊï∏Êìö (Standard):",
                load_demo: "ËºâÂÖ•ÁØÑ‰æã",
                sample_data: "Ê®£Êú¨Êï∏Êìö (Sample):",
                input_hint: "ÊèêÁ§∫ÔºöË´ãÁ¢∫‰øùÊï∏ÊìöÈñìÁÑ°Á©∫Ë°åÔºå‰ª•ÂÖçÂêçÁ®±ËàáÊï∏ÂÄºÈåØ‰Ωç„ÄÇ",
                replicates: "ODÈáçË§áÊï∏",
                dilution_factor: "Ê®£Êú¨Á®ÄÈáãÂÄçÊï∏:",
                dilution_hint: "Ë®àÁÆóÂá∫ÁöÑÊøÉÂ∫¶Â∞áÊúÉ‰πò‰ª•Ëº∏ÂÖ•ÁöÑÂÄçÊï∏ (Âü∫ÊñºÊ®ôÊ∫ñÂìÅÂõûÊ≠∏)„ÄÇ",
                calculate_btn: "ÈñãÂßãË®àÁÆó",
                export_btn: "ÂåØÂá∫ Excel",
                clear_btn: "Ê∏ÖÈô§ÂÖ®ÈÉ®",
                standard_curve: "Ê®ôÊ∫ñÊõ≤Á∑öÂúñ",
                calculation_results: "Ë®àÁÆóÁµêÊûú",
                calc_conc: "Êé®ÁÆóÊøÉÂ∫¶ (Œºg/ŒºL)",
                status: "ÂÇôË®ª",
                no_result: "Â∞öÁÑ°ÁµêÊûúÔºåË´ãËº∏ÂÖ•Êï∏ÊìöÂæåÈªûÊìäË®àÁÆó„ÄÇ",
                model_hint: "BradfordÔºö595nm / BCAÔºö 562nm",
                conc_lbl: "ÊøÉÂ∫¶ (Œºg/ŒºL)",
                od_lbl: "Âê∏ÂÖâÂÄº (OD)",
                ph_col: "Ë´ãË≤º‰∏äÊï¥Ê¨ÑÊï∏Êìö...",
                no_calc_alert: "Ë´ãÂÖàÈÄ≤Ë°åË®àÁÆóÂæåÂÜçÂåØÂá∫„ÄÇ",
                sample_name_input: "Ê®£Êú¨ÂêçÁ®±",
                sample_name_col: "Ê®£Êú¨ÂêçÁ®±",
                sample_od: "Ê®£Êú¨ OD",
                mean_od: "Âπ≥Âùá OD",
                download_offline: "‰∏ãËºâÈõ¢Á∑öÁâà", // Êñ∞Â¢û
                // Western Blot Translations
                wb_title: "Western Blot Ê®£Êú¨ÈÖçË£ΩË®àÁÆó",
                target_protein: "ÁõÆÊ®ôËõãÁôΩÈáè (¬µg)",
                target_vol: "ÂñÆÂ≠îÁõÆÊ®ôÈ´îÁ©ç (¬µL)",
                buffer_x: "Sample Buffer ÂÄçÊï∏",
                prep_n: "ÈÖçË£Ω‰ªΩÊï∏ (n)",
                col_prot_vol: "ËõãÁôΩÈ´îÁ©ç (¬µL)",
                col_water_vol: "ddH2OÈ´îÁ©ç (¬µL)",
                col_buff_vol: "BufferÈ´îÁ©ç (¬µL)",
                col_total_vol: "Á∏ΩÈ´îÁ©ç (¬µL)",
                r2_warning: "Ë≠¶ÂëäÔºöR¬≤ < 0.98ÔºåÁ∑öÊÄßÊì¨ÂêàÂ∫¶‰∏ç‰Ω≥ÔºåÁµêÊûúÂèØËÉΩ‰∏çÊ∫ñÁ¢∫„ÄÇ",
                note_high: "Ë∂ÖÂá∫Ê®ôÊ∫ñÊõ≤Á∑ö (High)",
                note_low: "‰ΩéÊñºÊ®ôÊ∫ñÊõ≤Á∑ö (Low)",
                note_neg: "Êï∏ÂÄºÁï∞Â∏∏ (<0)",
                err_buff_x: "ÈåØË™§ÔºöBufferÂÄçÊï∏ < 1"
            }
        };

        let currentLang = 'zh';
        let globalStdData = [];
        let globalSampleResults = [];
        let globalFitResult = null;
        let myChart = null;

        function setLang(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang][key]) el.textContent = i18n[lang][key];
            });
            document.querySelectorAll('.lang-switch-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(lang === 'en' ? 'English' : '‰∏≠Êñá')) btn.classList.add('active');
            });
            saveAndRenderAllInputs();
            if (myChart) {
                myChart.options.scales.x.title.text = i18n[lang].conc_lbl;
                myChart.options.scales.y.title.text = i18n[lang].od_lbl;
                myChart.update();
            }
            if(globalSampleResults.length > 0) calculate(); 
        }

        document.addEventListener('DOMContentLoaded', () => { setLang('zh'); });

        function saveAndRenderAllInputs() {
            let savedData = {
                stdConc: document.getElementById('std_conc_input')?.value || '',
                stdOds: [], 
                sampleName: document.getElementById('sample_name_input')?.value || '',
                sampleOds: []
            };
            
            let stdReps = parseInt(document.getElementById('stdReplicates').value);
            for(let r=1; r<=stdReps; r++) {
                savedData.stdOds.push(document.getElementById(`std_od_input_${r}`)?.value || '');
            }
            
            let sampleReps = parseInt(document.getElementById('sampleReplicates').value);
            for(let r=1; r<=sampleReps; r++) {
                savedData.sampleOds.push(document.getElementById(`sample_od_input_${r}`)?.value || '');
            }

            renderStandardInputs();
            renderSampleInputs();

            if(document.getElementById('std_conc_input')) document.getElementById('std_conc_input').value = savedData.stdConc;
            
            for(let r=1; r<=stdReps; r++) {
                if(document.getElementById(`std_od_input_${r}`)) {
                    document.getElementById(`std_od_input_${r}`).value = savedData.stdOds[r-1] || '';
                }
            }
            
            if(document.getElementById('sample_name_input')) document.getElementById('sample_name_input').value = savedData.sampleName;

            for(let r=1; r<=sampleReps; r++) {
                if(document.getElementById(`sample_od_input_${r}`)) {
                    document.getElementById(`sample_od_input_${r}`).value = savedData.sampleOds[r-1] || '';
                }
            }
        }

        function renderStandardInputs() {
            const reps = parseInt(document.getElementById('stdReplicates').value);
            const count = 10; 
            const container = document.getElementById('stdDataContainer');
            let html = `<div class="d-flex gap-2">`;
            html += `<div style="flex:1;"><div class="column-header">${i18n[currentLang].conc_lbl}</div><textarea id="std_conc_input" class="form-control bulk-textarea" rows="${count}" placeholder="${i18n[currentLang].ph_col}"></textarea></div>`;
            for(let r=1; r<=reps; r++) {
                html += `<div style="flex:1;"><div class="column-header">${i18n[currentLang].od_lbl} #${r}</div><textarea id="std_od_input_${r}" class="form-control bulk-textarea" rows="${count}" placeholder="${i18n[currentLang].ph_col}"></textarea></div>`;
            }
            html += `</div>`;
            container.innerHTML = html;
        }

        function renderSampleInputs() {
            const reps = parseInt(document.getElementById('sampleReplicates').value);
            const count = 10;
            const container = document.getElementById('sampleDataContainer');
            let html = `<div class="d-flex gap-2">`;
            html += `<div style="flex:1;"><div class="column-header">${i18n[currentLang].sample_name_input}</div><textarea id="sample_name_input" class="form-control bulk-textarea" rows="${count}" placeholder="${i18n[currentLang].ph_col}"></textarea></div>`;
            for(let r=1; r<=reps; r++) {
                html += `<div style="flex:1;"><div class="column-header">${i18n[currentLang].sample_od} #${r}</div><textarea id="sample_od_input_${r}" class="form-control bulk-textarea" rows="${count}" placeholder="${i18n[currentLang].ph_col}"></textarea></div>`;
            }
            html += `</div>`;
            container.innerHTML = html;
        }

        function parseBulkInput(elementId) {
            const el = document.getElementById(elementId);
            if (!el || !el.value.trim()) return [];
            let raw = el.value.trim();
            return raw.split(/\r?\n/).map(v => parseFloat(v.trim()));
        }

        function parseStringInput(elementId) {
            const el = document.getElementById(elementId);
            if (!el || !el.value.trim()) return [];
            let raw = el.value.trim();
            return raw.split(/\r?\n/).map(v => v.trim());
        }

        function getStandardData() {
            const reps = parseInt(document.getElementById('stdReplicates').value);
            let concArr = parseBulkInput('std_conc_input');
            let odArrs = [];
            for(let r=1; r<=reps; r++) odArrs.push(parseBulkInput(`std_od_input_${r}`));

            let data = [];
            for(let i=0; i<concArr.length; i++) {
                if (isNaN(concArr[i])) continue;
                let validOds = [];
                for(let r=0; r<reps; r++) {
                    if (odArrs[r] && odArrs[r][i] !== undefined && !isNaN(odArrs[r][i])) validOds.push(odArrs[r][i]);
                }
                if (validOds.length > 0) {
                    let avgOd = validOds.reduce((a,b)=>a+b, 0) / validOds.length;
                    data.push({ x: concArr[i], y: avgOd, rawOds: validOds });
                }
            }
            return data.sort((a, b) => a.x - b.x);
        }

        function getSampleData() {
            const reps = parseInt(document.getElementById('sampleReplicates').value);
            let odArrs = [];
            for(let r=1; r<=reps; r++) odArrs.push(parseBulkInput(`sample_od_input_${r}`));
            let nameArr = parseStringInput('sample_name_input');

            let maxLen = 0;
            odArrs.forEach(arr => { if(arr.length > maxLen) maxLen = arr.length; });
            
            let results = [];
            for(let i=0; i<maxLen; i++) {
                let validOds = [];
                for(let r=0; r<reps; r++) {
                    if (odArrs[r] && odArrs[r][i] !== undefined && !isNaN(odArrs[r][i])) validOds.push(odArrs[r][i]);
                }
                if(validOds.length > 0) {
                    let avgOd = validOds.reduce((a,b)=>a+b, 0) / validOds.length;
                    let sName = (nameArr[i] && nameArr[i].trim() !== "") ? nameArr[i] : `S${i+1}`;
                    results.push({ id: i+1, name: sName, od: avgOd, rawOds: validOds });
                }
            }
            return results;
        }

        function fitLinear(data) {
            let n = data.length, sX=0, sY=0, sXY=0, sXX=0;
            data.forEach(p => { sX+=p.x; sY+=p.y; sXY+=p.x*p.y; sXX+=p.x*p.x; });
            let slope = (n*sXY - sX*sY) / (n*sXX - sX*sX);
            let intercept = (sY - slope*sX) / n;
            
            if (Math.abs(slope) < 1e-10) {
                throw new Error("Standard Curve Slope is ‚âà 0 (Flat Line). Cannot calculate concentration.");
            }

            let ssRes=0, ssTot=0, mY=sY/n;
            data.forEach(p=>{ ssRes+=Math.pow(p.y-(slope*p.x+intercept),2); ssTot+=Math.pow(p.y-mY,2); });
            let r2 = 1-(ssRes/ssTot);

            let sign = intercept >= 0 ? "+" : "-";
            let absB = Math.abs(intercept);
            let equationStr = `y = ${slope.toFixed(5)}x ${sign} ${absB.toFixed(5)}`;

            return { 
                predict: x => slope*x + intercept, 
                solve: y => (y - intercept) / slope, 
                equation: equationStr, 
                r2: r2, 
                params: {slope, intercept} 
            };
        }

        // ==========================================
        //  WESTERN BLOT LOGIC
        // ==========================================
        function getWBValues(conc, targetMass, targetVol, bufferX, prepN) {
            if (typeof conc !== 'number' || isNaN(conc) || conc <= 0) {
                return { valid: false, reason: "Invalid Conc", vals: null };
            }
            
            // Logic Check: Buffer X cannot be < 1 (Dilution impossible)
            if (bufferX < 2) {
                return { valid: false, reason: "BuffX < 2", vals: null };
            }

            let v_prot = (targetMass / conc) * prepN;
            let v_buff = (targetVol / bufferX) * prepN;
            let v_total = targetVol * prepN;
            let v_water = v_total - v_prot - v_buff;

            return { 
                valid: true, 
                reason: "OK", 
                vals: { v_prot, v_water, v_buff, v_total }
            };
        }

        function calculateRecipe() {
            let targetMass = parseFloat(document.getElementById('wb_mass').value) || 0;
            let targetVol = parseFloat(document.getElementById('wb_vol').value) || 0;
            let bufferX = parseFloat(document.getElementById('wb_buffer').value) || 1;
            let prepN = parseFloat(document.getElementById('wb_n').value) || 1;

            let tbody = document.getElementById('recipeTableBody');
            tbody.innerHTML = '';

            if (globalSampleResults.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-muted py-3">${i18n[currentLang].no_result}</td></tr>`;
                return;
            }

            globalSampleResults.forEach(res => {
                let wbData = getWBValues(res.conc, targetMass, targetVol, bufferX, prepN);
                
                let rowHtml = `<td>${res.name}</td>`;
                
                if (wbData.valid) {
                    let v = wbData.vals;
                    let waterClass = (v.v_water < 0) ? "text-danger fw-bold" : "";
                    
                    rowHtml += `
                        <td>${v.v_prot.toFixed(2)}</td>
                        <td class="${waterClass}">${v.v_water.toFixed(2)}</td>
                        <td>${v.v_buff.toFixed(2)}</td>
                        <td>${v.v_total.toFixed(2)}</td>
                    `;
                } else {
                    let msg = "---";
                    if(wbData.reason === "BuffX < 2") msg = `<span class="text-danger">Buffer X < 2</span>`;
                    rowHtml += `<td colspan="4" class="text-muted text-center align-middle">${msg}</td>`;
                }
                tbody.innerHTML += `<tr>${rowHtml}</tr>`;
            });
        }

        // ==========================================
        //  MAIN CALCULATION
        // ==========================================
        function calculate() {
            globalStdData = getStandardData();
            let dilution = parseFloat(document.getElementById('dilutionFactor').value) || 1;
            
            if (globalStdData.length < 2) { alert(i18n[currentLang].no_result); return; }

            let maxStdOD = Math.max(...globalStdData.map(d => d.y));
            let minStdOD = Math.min(...globalStdData.map(d => d.y));

            let fitModel;
            try {
                fitModel = fitLinear(globalStdData);
            } catch(e) {
                console.error(e);
                alert("Calculation Failed: " + e.message); 
                return;
            }

            globalFitResult = fitModel;
            document.getElementById('r2_score').innerHTML = `${fitModel.equation} <br> <span class="badge bg-success" style="float:right;">R¬≤ = ${fitModel.r2.toFixed(5)}</span>`;

            let warningBox = document.getElementById('r2_warning_box');
            if(fitModel.r2 < 0.98) {
                warningBox.textContent = i18n[currentLang].r2_warning;
                warningBox.style.display = 'block';
            } else {
                warningBox.style.display = 'none';
            }

            let sampleList = getSampleData();
            let results = [];
            sampleList.forEach(item => {
                let conc = fitModel.solve(item.od);
                let note = "";
                let statusType = "ok"; 

                // Range Check Logic 
                if (conc < 0) {
                    note = i18n[currentLang].note_neg;
                    statusType = "danger";
                } else if (item.od > maxStdOD) {
                    note = i18n[currentLang].note_high;
                    statusType = "warning";
                } else if (item.od < minStdOD) {
                    note = i18n[currentLang].note_low;
                    statusType = "gray";
                }

                let finalConc = isNaN(conc) ? NaN : conc * dilution;
                results.push({ ...item, conc: finalConc, note: note, statusType: statusType });
            });
            globalSampleResults = results;

            let tbody = document.getElementById('resultTableBody');
            tbody.innerHTML = '';
            results.forEach((res) => {
                let valStr = isNaN(res.conc) ? "---" : res.conc.toFixed(4);
                let valClass = (res.conc < 0) ? "text-danger fw-bold" : "fw-bold text-primary";
                
                let badgeClass = "bg-success";
                if(res.statusType === "warning") badgeClass = "bg-warning text-dark";
                if(res.statusType === "danger") badgeClass = "bg-danger";
                if(res.statusType === "gray") badgeClass = "bg-secondary";
                
                let statusBadge = res.note 
                    ? `<span class="badge ${badgeClass}">${res.note}</span>` 
                    : `<span class="badge bg-success">OK</span>`;

                tbody.innerHTML += `<tr>
                    <td>${res.name}</td>
                    <td>${res.od.toFixed(4)}</td>
                    <td class="${valClass}">${valStr}</td>
                    <td>${statusBadge}</td>
                </tr>`;
            });

            drawChart(globalStdData, fitModel, results);
            calculateRecipe(); 
        }

        function drawChart(stdData, fitModel, sampleResults) {
            const ctx = document.getElementById('elisaChart').getContext('2d');
            
            let maxStdX = Math.max(...stdData.map(d => d.x));
            let maxSampleX = 0;
            if(sampleResults && sampleResults.length > 0) {
                 sampleResults.forEach(s => {
                     if(s.conc && s.conc > maxSampleX && s.conc < maxStdX * 3) maxSampleX = s.conc; 
                 });
            }
            let maxX = Math.max(maxStdX, maxSampleX);

            let fitPoints = [];
            for(let i=0; i<=100; i++) {
                let x = (maxX * 1.1) * (i/100);
                let y = fitModel.predict(x);
                fitPoints.push({x: x, y: y});
            }

            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        { label: 'Std Data', data: stdData, backgroundColor:'#0d6efd', pointRadius:5 },
                        { label: 'Linear Fit', data: fitPoints, type:'line', borderColor:'#0d6efd', borderWidth:2, pointRadius:0, borderDash:[5,5], fill:false, tension:0 }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        x: {
                            type: 'linear', 
                            position:'bottom', 
                            title:{display:true, text:i18n[currentLang].conc_lbl},
                            min: 0
                        }, 
                        y: {
                            title:{display:true, text:i18n[currentLang].od_lbl},
                            min: 0 // VISUAL FIX: Force Y-axis to start at 0
                        } 
                    } 
                }
            });
        }

        function loadDemoData() {
            document.getElementById('stdReplicates').value = '2'; 
            renderStandardInputs();
            
            setTimeout(() => {
                document.getElementById('std_conc_input').value = "0\n125\n250\n500\n750\n1000\n1500\n2000";
                document.getElementById('std_od_input_1').value = "0.000\n0.055\n0.112\n0.220\n0.310\n0.415\n0.605\n0.810";
                document.getElementById('std_od_input_2').value = "0.002\n0.051\n0.108\n0.225\n0.315\n0.420\n0.595\n0.800";
            }, 50);

            document.getElementById('sampleReplicates').value = '2';
            renderSampleInputs();
            setTimeout(() => {
                document.getElementById('sample_name_input').value = "High OD\nLow OD\nNormal\nNeg Control";
                document.getElementById('sample_od_input_1').value = "1.200\n0.001\n0.450\n0.005";
                document.getElementById('sample_od_input_2').value = "1.210\n0.002\n0.445\n0.004";
            }, 50);
        }

        function clearData() {
            renderStandardInputs(); 
            renderSampleInputs(); 
            document.getElementById('resultTableBody').innerHTML = `<tr><td colspan="4" class="text-center text-muted">${i18n[currentLang].no_result}</td></tr>`;
            document.getElementById('recipeTableBody').innerHTML = `<tr><td colspan="5" class="text-muted py-3">${i18n[currentLang].no_result}</td></tr>`;
            if(myChart) { myChart.destroy(); myChart = null; }
            document.getElementById('r2_score').textContent = '';
            document.getElementById('r2_warning_box').style.display = 'none';
            globalStdData = []; globalSampleResults = [];
        }

        function exportExcel() {
            if (globalSampleResults.length === 0) { alert(i18n[currentLang].no_calc_alert); return; }
            
            const wb = XLSX.utils.book_new();
            const now = new Date().toLocaleString();
            let dilution = document.getElementById('dilutionFactor').value;

            // ==========================================
            //  PART 1: Protein Quantification Results
            // ==========================================
            let maxSampleReps = 0;
            globalSampleResults.forEach(res => { if(res.rawOds && res.rawOds.length > maxSampleReps) maxSampleReps = res.rawOds.length; });
            
            let sampleHeader = ["Sample Name"];
            for(let i=1; i<=maxSampleReps; i++) sampleHeader.push(`OD #${i}`);
            sampleHeader.push("Mean OD", "Conc (¬µg/ŒºL)", "Status");

            let wsData = [ 
                ["Protein Quantification Report (Bradford/BCA)"], 
                ["Date", now], 
                ["Model", "Linear Regression (y=ax+b)"],
                ["Dilution Factor", dilution], 
                ["R2", globalFitResult.r2.toFixed(6)],
                [], 
                ["--- Parameters ---"],
                ["Equation", globalFitResult.equation.replace(/<br>/g, " | ").replace(/<b>|<\/b>/g, "")],
                [],
                sampleHeader 
            ];
            
            globalSampleResults.forEach(res => {
                let row = [res.name];
                for(let i=0; i<maxSampleReps; i++) row.push((res.rawOds && res.rawOds[i] !== undefined) ? res.rawOds[i] : "");
                let concVal = (typeof res.conc==='number' && !isNaN(res.conc) ? Number(res.conc.toFixed(4)) : "NaN");
                row.push(res.od, concVal, (res.note||"OK"));
                wsData.push(row);
            });

            // ==========================================
            //  PART 2: Western Blot Recipe Calculation
            // ==========================================
            let targetMass = parseFloat(document.getElementById('wb_mass').value) || 0;
            let targetVol = parseFloat(document.getElementById('wb_vol').value) || 0;
            let bufferX = parseFloat(document.getElementById('wb_buffer').value) || 1;
            let prepN = parseFloat(document.getElementById('wb_n').value) || 1;

            wsData.push([]); 
            wsData.push([]); 
            wsData.push(["--- Western Blot Recipe Calculation ---"]);
            wsData.push(["Target Mass (¬µg)", targetMass]);
            wsData.push(["Target Volume (per well, ¬µL)", targetVol]);
            wsData.push(["Sample Buffer (X)", bufferX]);
            wsData.push(["Replicates (n)", prepN]);
            wsData.push([]);

            wsData.push(["Sample Name", "Protein Vol (¬µL)", "ddH2O (¬µL)", "Buffer Vol (¬µL)", "Total Vol (¬µL)"]);

            globalSampleResults.forEach(res => {
                let wbData = getWBValues(res.conc, targetMass, targetVol, bufferX, prepN);
                
                if (wbData.valid) {
                    let v = wbData.vals;
                    wsData.push([
                        res.name,
                        Number(v.v_prot.toFixed(2)),
                        Number(v.v_water.toFixed(2)),
                        Number(v.v_buff.toFixed(2)),
                        Number(v.v_total.toFixed(2))
                    ]);
                } else {
                     let errMsg = "Invalid";
                     if(wbData.reason === "BuffX < 1") errMsg = "Buffer X < 1";
                     wsData.push([res.name, errMsg, "---", "---", "---"]);
                }
            });

            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), "Results");

            // ==========================================
            //  PART 3: Standard Curve Data Sheet
            // ==========================================
            let maxStdReps = 0;
            globalStdData.forEach(pt => { if(pt.rawOds && pt.rawOds.length > maxStdReps) maxStdReps = pt.rawOds.length; });
            let stdHeader = ["Concentration (X) (¬µg/ŒºL)"];
            for(let i=1; i<=maxStdReps; i++) stdHeader.push(`OD #${i}`);
            stdHeader.push("Mean OD (Y)");
            
            let stdWsData = [ ["Standard Curve Data"], [], stdHeader ];
            globalStdData.forEach(pt => {
                let row = [pt.x];
                for(let i=0; i<maxStdReps; i++) row.push((pt.rawOds && pt.rawOds[i] !== undefined) ? pt.rawOds[i] : "");
                row.push(pt.y);
                stdWsData.push(row);
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(stdWsData), "Standards");

            XLSX.writeFile(wb, "Protein_Quant_Result.xlsx");
        }
    </script>
</body>
</html>