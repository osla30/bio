<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>qPCR åˆ†æå·¥å…· / qPCR Analysis Tool</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jstat@1.9.6/dist/jstat.min.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --bg: #f4f6f9;
            --card-bg: #ffffff;
            --excel-green: #217346;
            --excel-dark: #14442a;
        }

        body {
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--primary);
            line-height: 1.5;
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 1200px; margin: 0 auto; position: relative; }
        
        .header-row {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin-bottom: 30px;
        }
        h1 { margin: 0; text-align: center; }

        .header-controls {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 10px;
        }

        .top-btn {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 5px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
            line-height: normal;
        }
        .top-btn:hover { background: var(--accent); color: white; }

        .card {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e1e4e8;
        }

        .step-title {
            font-size: 1.2em;
            font-weight: 700;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .gene-block {
            background-color: #fafbfc;
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .gene-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding-right: 40px;
        }

        .gene-name-input {
            font-size: 1.1em;
            font-weight: bold;
            padding: 5px;
            border: 1px solid #aaa;
            border-radius: 4px;
            width: 200px;
            color: #d35400;
        }

        .input-row { display: flex; gap: 15px; }
        .input-col { flex: 1; }
        
        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9em; }
        
        textarea {
            width: 100%;
            height: 180px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }

        button {
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 5px;
            border: none;
            font-size: 15px;
            font-weight: bold;
            transition: 0.2s;
            white-space: nowrap;
        }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-primary:hover { background-color: #1f6391; }
        
        .btn-success { background-color: var(--success); color: white; width: 100%; padding: 12px; font-size: 16px; }
        .btn-success:hover { background-color: #219150; }

        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { background-color: #c0392b; }

        .btn-add { background-color: var(--warning); color: #fff; }
        .btn-add:hover { background-color: #e67e22; }

        .btn-excel {
            background-color: var(--excel-green); 
            color: white;
            padding: 6px 15px; 
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-excel:hover { background-color: #1a5c38; }

        .btn-excel-all {
            background-color: var(--excel-dark);
            color: white;
            padding: 6px 15px; 
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-excel-all:hover { background-color: #0d2e1c; }

        .delete-block-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: transparent;
            color: #999;
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
        }
        .delete-block-btn:hover {
            background-color: #ffebee;
            color: var(--danger);
            border-color: var(--danger);
        }

        input[type="number"] { padding: 8px; width: 60px; text-align: center; font-size: 16px; }
        select, input[type="text"] { padding: 10px; width: 100%; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }

        /* å¤šé¸æ¡†å®¹å™¨æ¨£å¼ */
        .checkbox-container {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            background: #fff;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .checkbox-item input {
            margin-right: 8px;
            width: auto;
        }
        .checkbox-item label {
            margin-bottom: 0;
            cursor: pointer;
            font-weight: normal;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th, td { padding: 8px 10px; text-align: center; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; position: sticky; top: 0; z-index: 10; }
        tr:hover { background-color: #f1f1f1; }

        tr.gene-separator { border-top: 2px solid #bdc3c7; }

        .hidden { display: none; }
        .error-msg { color: red; font-size: 0.9em; margin-top: 5px; display: none; }
        .info-box { background: #e8f4fd; color: #0c5460; padding: 10px; border-radius: 5px; font-size: 0.9em; margin-top: 10px; }
        .warning-box { background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; border: 1px solid #ffeeba; margin-bottom: 20px; display: none; }
        
        td { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
        
        .checkbox-wrapper { display: flex; align-items: center; margin-top: 5px; font-size: 0.9em; color: #555; gap: 5px; }
        .checkbox-wrapper input { width: auto; margin: 0; }

        .stat-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }
        @media (max-width: 900px) {
            .stat-grid { grid-template-columns: 1fr; }
        }
        .stat-panel {
            background: #fafbfc;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .anova-result-box {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.95em;
            border-left: 5px solid;
        }
        .anova-pass {
            background-color: #d4edda;
            color: #155724;
            border-color: #28a745;
        }
        .anova-fail {
            background-color: #ffebee;
            color: #c0392b; 
            border-color: #ef9a9a;
        }

        .stat-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        .stat-item:last-child { border-bottom: none; }
        .stat-val { font-weight: bold; color: #2c3e50; }
        .stat-sig { color: #e74c3c; font-weight: bold; }
        .stat-method { color: #8e44ad; font-size: 0.85em; display: block; margin-top: 3px; font-style: italic; }
        
        @media (max-width: 600px) {
            .header-row { flex-direction: column; gap: 10px; }
            .header-controls { position: static; transform: none; margin-top: 10px; }
            .export-btn-group { flex-direction: column; width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-row">
        <h1 data-i18n="title">ğŸ§¬ qPCR ç›¸å°å®šé‡åˆ†æå·¥å…· 2^(-Î”Î”Ct)</h1>
        
        <div class="header-controls">
            <a href="https://drive.google.com/file/d/1yDgXBFR4p9nPmxe5KaJ15Y5XY6S_jSX9/view?usp=sharing" class="top-btn" target="_blank" title="Download Offline Version">
                ğŸ“¥ <span data-i18n="btnOffline">ä¸‹è¼‰é›¢ç·šç‰ˆ</span>
            </a>
            <button class="top-btn" onclick="toggleLanguage()">
                ğŸŒ <span id="langText">English</span>
            </button>
        </div>
    </div>

    <div class="card">
        <div class="step-title" data-i18n="step1">1. åˆå§‹è¨­å®š</div>
        <div style="display:flex; align-items:center; gap:15px; flex-wrap: wrap;">
            <label data-i18n="initGeneCount">åˆå§‹åŸºå› æ•¸é‡ï¼š</label>
            <input type="number" id="geneCountInput" value="2" min="2" max="20">
            <button class="btn-primary" onclick="generateGeneBlocks()" data-i18n="startBuild">é–‹å§‹å»ºç«‹å€å¡Š</button>
            <span style="margin-left:auto; font-size:0.9em; color:#666; cursor:pointer; text-decoration:underline;" onclick="loadDemoData()" data-i18n="loadDemo">[è¼‰å…¥ç¯„ä¾‹æ•¸æ“š]</span>
        </div>
        <div style="color: #7f8c8d; font-size: 0.9em; margin-top: 5px;" data-i18n="minGeneNote">
            * è‡³å°‘éœ€è¦ 2 å€‹åŸºå›  (å«å…§åƒèˆ‡ç›®æ¨™)
        </div>
    </div>

    <div id="dataEntrySection" class="card hidden">
        <div class="step-title">
            <span data-i18n="step2">2. è¼¸å…¥æ•¸æ“š</span>
            <div style="display:flex; gap:10px;">
                <button class="btn-add" onclick="addSingleBlock(false)" data-i18n="addBlock">â• æ–°å¢ä¸€å€‹å€å¡Š</button>
                <button class="btn-danger" onclick="clearAllBlocks()" data-i18n="clearBlocks">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰å€å¡Š</button>
            </div>
        </div>
        
        <p style="font-size:0.9em; color:#666; margin-bottom:15px;" data-i18n="dataInstr">
           è«‹è¼¸å…¥æ¨£æœ¬åç¨±èˆ‡ Ct å€¼ã€‚ç³»çµ±æœƒè‡ªå‹•è¨ˆç®—<span style='color: #e74c3c; font-weight: bold;'>ç›¸åŒæ¨£æœ¬åç¨±</span>çš„å¹³å‡ Ct å€¼ <span style='color: #e74c3c; font-weight: bold;'>(æŠ€è¡“é‡è¤‡)</span>ã€‚<br>è‹¥ç‚º<span style='color: #e74c3c; font-weight: bold;'>ä¸åŒçš„ç¨ç«‹æ¨£æœ¬ (ç”Ÿç‰©é‡è¤‡)</span>ï¼Œè«‹å‹™å¿…ä½¿ç”¨ä¸åŒåç¨±å€åˆ† (å¦‚ WT-1, WT-2)ã€‚
        </p>

        <div id="geneBlocksContainer"></div>
        
        <div style="margin-top: 20px;">
            <button class="btn-success" onclick="processData()" data-i18n="nextStep">ä¸‹ä¸€æ­¥ï¼šè¨­å®šåƒæ•¸</button>
        </div>
        <div id="globalError" style="color:red; text-align:center; margin-top:10px;"></div>
    </div>

    <div id="settingsSection" class="card hidden">
        <div class="step-title" data-i18n="step3">3. åƒæ•¸è¨­å®š</div>
        
        <div style="display:flex; gap:30px; flex-wrap:wrap;">
            <div style="flex:1; min-width:300px;">
                <label data-i18n="refGeneLabel">é¸æ“‡å…§åƒåŸºå›  (Reference Genes)</label>
                <div id="refGeneSelectContainer" class="checkbox-container"></div>
                
                <div class="info-box">
                    <span data-i18n="deltaCtFormula">ç”¨æ–¼è¨ˆç®— $\Delta Ct = Ct_{Target} - \text{Mean}(Ct_{Refs})$</span>
                    <br>
                    <span style="font-size:0.85em; color:#666;" data-i18n="multiRefNote">
                    * æ”¯æ´å¤šé‡å…§åƒï¼šè‹¥é¸æ“‡å¤šå€‹ï¼Œå°‡ä½¿ç”¨å…¶ Ct å€¼çš„ç®—è¡“å¹³å‡æ•¸ (ç­‰åŒæ–¼è¡¨ç¾é‡çš„å¹¾ä½•å¹³å‡) é€²è¡Œæ ¡æ­£ã€‚
                    </span>
                </div>
            </div>

            <div style="flex:1; min-width:300px;">
                <label data-i18n="controlKeyLabel">å°ç…§çµ„é—œéµå­— (Control Keyword)</label>
                <input type="text" id="controlKeyword" value="WT" placeholder="ä¾‹å¦‚: WT">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="exactMatchCheckbox">
                    <label for="exactMatchCheckbox" style="margin-bottom:0; font-weight:normal; cursor:pointer;" data-i18n="exactMatch">å®Œå…¨ç¬¦åˆ (Exact Match) - ç”¨æ–¼ç²¾ç¢ºç¾¤çµ„æ¯”å° (å¦‚ "WT" vs "WT-1")</label>
                </div>
                <div class="info-box" style="margin-top: 5px;" data-i18n="calibratorNote">
                    ç³»çµ±æœƒæ‰¾å‡ºç¬¦åˆæ­¤é—œéµå­—çš„æ¨£æœ¬ï¼Œ<br>
                    ç®—å‡º <b>å¹³å‡ $\Delta Ct$</b> ä½œç‚ºæ ¡æ­£åŸºæº– (Calibrator)ã€‚
                </div>
            </div>
        </div>

        <button class="btn-primary" style="margin-top:20px; width:100%" onclick="calculateResults()" data-i18n="startCalc">é–‹å§‹è¨ˆç®—</button>
    </div>

    <div id="resultSection" class="card hidden">
        <div class="step-title">
            <span data-i18n="step4">4. åˆ†æçµæœ</span>
            <button class="btn-excel" onclick="exportCSV()" data-i18n="exportCSV">ğŸ“Š åŒ¯å‡º CSV (Excel)</button>
        </div>
        
        <div id="warningBox" class="warning-box"></div>
        
        <div style="margin-bottom:10px; font-weight:bold; color:#2980b9;" id="calibratorInfo"></div>

        <div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
            <table id="resultTable">
                <thead>
                    <tr>
                        <th style="width:10%" data-i18n="colGene">åŸºå› </th>
                        <th style="width:15%" data-i18n="colSample">æ¨£æœ¬</th>
                        <th>Mean Ct</th>
                        <th>Î”Ct</th>
                        <th>Î”Î”Ct</th>
                        <th>Fold Change</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="statsSection" class="card hidden">
        <div class="step-title">
            <span data-i18n="step5">5. çµ±è¨ˆåˆ†æèˆ‡ä½œåœ– (Statistics & Plots)</span>
            <div class="export-btn-group" style="display:flex; gap:10px;">
                <button class="btn-excel" onclick="exportStatsCSV()">ğŸ“Š <span data-i18n="btnExportStats">åŒ¯å‡ºç•¶å‰åŸºå› çµ±è¨ˆ</span></button>
                <button class="btn-excel-all" onclick="exportAllStatsCSV()">ğŸ“‘ <span data-i18n="btnExportAllStats">åŒ¯å‡ºå…¨éƒ¨åŸºå› çµ±è¨ˆ</span></button>
            </div>
        </div>
        
        <div class="info-box" style="margin-bottom:20px;">
            <strong data-i18n="statNoteTitle">ğŸ’¡ çµ±è¨ˆç§‘å­¸ä¿®æ­£èªªæ˜ï¼š</strong>
            <span data-i18n="statNoteBody">
                ç‚ºäº†ç¬¦åˆå¸¸æ…‹åˆ†ä½ˆå‡è¨­ï¼Œ<b>P å€¼è¨ˆç®—æ¡ç”¨ Î”Ct å€¼</b>ã€‚<br>
                3 çµ„ä»¥ä¸ŠåŸ·è¡Œ <b>ANOVA + Dunnett's Test</b> (èˆ‡ Control æ¯”è¼ƒ)ã€‚<br>
                åƒ… 2 çµ„æ™‚åŸ·è¡Œ <b>Welch's t-test</b> (ä¸å‡è¨­è®Šç•°æ•¸ç›¸ç­‰)ã€‚
            </span>
        </div>

        <div class="stat-grid">
            <div class="stat-panel">
                <h4 style="margin-top:0; border-bottom:1px solid #ddd; padding-bottom:10px;" data-i18n="statPanelTitle">çµ±è¨ˆæª¢å®šçµæœ (åŸºæ–¼ Î”Ct)</h4>
                <div id="statResultsContainer"></div>
            </div>

            <div>
                 <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <label data-i18n="plotGeneLabel">é¸æ“‡ç¹ªåœ–åŸºå› ï¼š</label>
                    <select id="plotGeneSelect" onchange="updatePlot()" style="width:auto; padding:5px;"></select>
                 </div>
                 <div id="plotlyChart" style="width:100%; height:500px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- æ“´å……ç‰ˆçµ±è¨ˆè‡¨ç•Œå€¼è¡¨ ---
    // 1. Alpha = 0.05 (*)
    const DUNNETT_D_TABLE_05 = {
        2: { 5: 2.57, 10: 2.23, 15: 2.13, 20: 2.09, 30: 2.04, 60: 2.00, 120: 1.98, 999: 1.96 },
        3: { 5: 3.03, 10: 2.57, 15: 2.44, 20: 2.38, 30: 2.32, 60: 2.27, 120: 2.24, 999: 2.21 },
        4: { 5: 3.39, 10: 2.81, 15: 2.64, 20: 2.57, 30: 2.50, 60: 2.43, 120: 2.39, 999: 2.36 },
        5: { 5: 3.66, 10: 2.97, 15: 2.79, 20: 2.70, 30: 2.62, 60: 2.55, 120: 2.51, 999: 2.47 },
        6: { 5: 3.87, 10: 3.11, 15: 2.90, 20: 2.81, 30: 2.72, 60: 2.63, 120: 2.59, 999: 2.55 },
        7: { 5: 4.05, 10: 3.22, 15: 2.99, 20: 2.89, 30: 2.80, 60: 2.71, 120: 2.66, 999: 2.62 },
        8: { 5: 4.20, 10: 3.31, 15: 3.07, 20: 2.96, 30: 2.87, 60: 2.77, 120: 2.72, 999: 2.68 },
        9: { 5: 4.33, 10: 3.39, 15: 3.14, 20: 3.03, 30: 2.93, 60: 2.83, 120: 2.78, 999: 2.73 },
        10: { 5: 4.45, 10: 3.47, 15: 3.20, 20: 3.08, 30: 2.98, 60: 2.88, 120: 2.83, 999: 2.78 },
        11: { 5: 4.55, 10: 3.53, 15: 3.25, 20: 3.13, 30: 3.03, 60: 2.92, 120: 2.87, 999: 2.82 },
        12: { 5: 4.65, 10: 3.59, 15: 3.30, 20: 3.18, 30: 3.07, 60: 2.96, 120: 2.91, 999: 2.86 },
        13: { 5: 4.73, 10: 3.64, 15: 3.35, 20: 3.22, 30: 3.11, 60: 3.00, 120: 2.94, 999: 2.89 },
        14: { 5: 4.81, 10: 3.69, 15: 3.39, 20: 3.26, 30: 3.14, 60: 3.03, 120: 2.97, 999: 2.92 },
        15: { 5: 4.88, 10: 3.73, 15: 3.43, 20: 3.29, 30: 3.17, 60: 3.06, 120: 3.00, 999: 2.95 },
        16: { 5: 4.95, 10: 3.77, 15: 3.46, 20: 3.32, 30: 3.20, 60: 3.09, 120: 3.03, 999: 2.98 },
        17: { 5: 5.01, 10: 3.81, 15: 3.50, 20: 3.35, 30: 3.23, 60: 3.12, 120: 3.06, 999: 3.00 },
        18: { 5: 5.07, 10: 3.85, 15: 3.53, 20: 3.38, 30: 3.26, 60: 3.14, 120: 3.08, 999: 3.03 },
        19: { 5: 5.12, 10: 3.88, 15: 3.56, 20: 3.41, 30: 3.28, 60: 3.17, 120: 3.10, 999: 3.05 },
        20: { 5: 5.17, 10: 3.91, 15: 3.59, 20: 3.43, 30: 3.30, 60: 3.19, 120: 3.12, 999: 3.07 },
        24: { 5: 5.35, 10: 4.02, 15: 3.69, 20: 3.53, 30: 3.39, 60: 3.27, 120: 3.20, 999: 3.15 },
        30: { 5: 5.55, 10: 4.15, 15: 3.80, 20: 3.63, 30: 3.49, 60: 3.36, 120: 3.29, 999: 3.23 },
        40: { 5: 5.80, 10: 4.30, 15: 3.94, 20: 3.76, 30: 3.60, 60: 3.47, 120: 3.39, 999: 3.33 },
        60: { 5: 6.13, 10: 4.51, 15: 4.12, 20: 3.92, 30: 3.76, 60: 3.61, 120: 3.53, 999: 3.46 },
        100: { 5: 6.50, 10: 4.75, 15: 4.33, 20: 4.12, 30: 3.94, 60: 3.78, 120: 3.69, 999: 3.61 }
    };

    // 2. Alpha = 0.01 (**)
    const DUNNETT_D_TABLE_01 = {
        2: { 5: 4.03, 10: 3.17, 15: 2.95, 20: 2.84, 30: 2.75, 60: 2.66, 120: 2.62, 999: 2.58 },
        3: { 5: 4.63, 10: 3.56, 15: 3.29, 20: 3.15, 30: 3.03, 60: 2.92, 120: 2.86, 999: 2.81 },
        4: { 5: 4.98, 10: 3.80, 15: 3.48, 20: 3.33, 30: 3.19, 60: 3.06, 120: 2.99, 999: 2.94 },
        5: { 5: 5.22, 10: 3.96, 15: 3.62, 20: 3.46, 30: 3.31, 60: 3.16, 120: 3.09, 999: 3.04 },
        6: { 5: 5.41, 10: 4.10, 15: 3.73, 20: 3.56, 30: 3.40, 60: 3.24, 120: 3.17, 999: 3.11 },
        7: { 5: 5.56, 10: 4.21, 15: 3.82, 20: 3.64, 30: 3.48, 60: 3.31, 120: 3.23, 999: 3.18 },
        8: { 5: 5.69, 10: 4.30, 15: 3.90, 20: 3.71, 30: 3.54, 60: 3.37, 120: 3.29, 999: 3.23 },
        9: { 5: 5.80, 10: 4.39, 15: 3.97, 20: 3.77, 30: 3.59, 60: 3.42, 120: 3.33, 999: 3.28 },
        10: { 5: 5.89, 10: 4.46, 15: 4.03, 20: 3.82, 30: 3.64, 60: 3.46, 120: 3.37, 999: 3.32 }
    };

    // 3. Alpha = 0.001 (***)
    const DUNNETT_D_TABLE_001 = {
        2: { 5: 6.87, 10: 4.59, 15: 4.07, 20: 3.85, 30: 3.65, 60: 3.46, 120: 3.37, 999: 3.29 },
        3: { 5: 7.60, 10: 5.06, 15: 4.48, 20: 4.22, 30: 3.99, 60: 3.77, 120: 3.67, 999: 3.48 },
        4: { 5: 8.03, 10: 5.35, 15: 4.73, 20: 4.46, 30: 4.21, 60: 3.97, 120: 3.86, 999: 3.59 },
        5: { 5: 8.34, 10: 5.56, 15: 4.92, 20: 4.63, 30: 4.37, 60: 4.12, 120: 4.00, 999: 3.67 },
        6: { 5: 8.59, 10: 5.73, 15: 5.07, 20: 4.77, 30: 4.50, 60: 4.23, 120: 4.11, 999: 3.73 },
        7: { 5: 8.79, 10: 5.87, 15: 5.19, 20: 4.89, 30: 4.61, 60: 4.33, 120: 4.20, 999: 3.78 },
        8: { 5: 8.96, 10: 5.99, 15: 5.30, 20: 4.99, 30: 4.70, 60: 4.42, 120: 4.29, 999: 3.82 },
        9: { 5: 9.11, 10: 6.09, 15: 5.39, 20: 5.08, 30: 4.78, 60: 4.49, 120: 4.36, 999: 3.86 },
        10: { 5: 9.24, 10: 6.18, 15: 5.47, 20: 5.16, 30: 4.86, 60: 4.56, 120: 4.42, 999: 3.89 },
        12: { 5: 9.46, 10: 6.34, 15: 5.61, 20: 5.29, 30: 4.98, 60: 4.68, 120: 4.53, 999: 3.95 },
        15: { 5: 9.72, 10: 6.52, 15: 5.77, 20: 5.44, 30: 5.12, 60: 4.81, 120: 4.66, 999: 4.02 },
        20: { 5: 10.05, 10: 6.75, 15: 5.98, 20: 5.63, 30: 5.30, 60: 4.98, 120: 4.82, 999: 4.11 }
    };

    // --- å¤šèªè¨€è¨­å®š ---
    let currentLang = 'zh'; 
    
    const translations = {
        'zh': {
            title: "ğŸ§¬ qPCR ç›¸å°å®šé‡åˆ†æå·¥å…· 2^(-Î”Î”Ct)",
            langBtn: "English",
            btnOffline: "ä¸‹è¼‰é›¢ç·šç‰ˆ",
            step1: "1. åˆå§‹è¨­å®š",
            initGeneCount: "åˆå§‹åŸºå› æ•¸é‡ï¼š",
            startBuild: "é–‹å§‹å»ºç«‹å€å¡Š",
            loadDemo: "[è¼‰å…¥ç¯„ä¾‹æ•¸æ“š]",
            minGeneNote: "* è‡³å°‘éœ€è¦ 2 å€‹åŸºå›  (å«å…§åƒèˆ‡ç›®æ¨™)",
            step2: "2. è¼¸å…¥æ•¸æ“š",
            addBlock: "â• æ–°å¢ä¸€å€‹å€å¡Š",
            clearBlocks: "ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰å€å¡Š",
            dataInstr: "è«‹è¼¸å…¥æ¨£æœ¬åç¨±èˆ‡ Ct å€¼ã€‚ç³»çµ±æœƒè‡ªå‹•è¨ˆç®—<span style='color: #e74c3c; font-weight: bold;'>ç›¸åŒæ¨£æœ¬åç¨±</span>çš„å¹³å‡ Ct å€¼ <span style='color: #e74c3c; font-weight: bold;'>(æŠ€è¡“é‡è¤‡)</span>ã€‚<br>è‹¥ç‚º<span style='color: #e74c3c; font-weight: bold;'>ä¸åŒçš„ç¨ç«‹æ¨£æœ¬ (ç”Ÿç‰©é‡è¤‡)</span>ï¼Œè«‹å‹™å¿…ä½¿ç”¨ä¸åŒåç¨±å€åˆ† (å¦‚ WT-1, WT-2)ã€‚",
            nextStep: "ä¸‹ä¸€æ­¥ï¼šè¨­å®šåƒæ•¸",
            geneNameLabel: "åŸºå› åç¨±ï¼š",
            sampleLabel: "â¬‡ï¸ æ¨£æœ¬åç¨± (Sample)",
            ctLabel: "â¬‡ï¸ Ct å€¼ (è¼¸å…¥åŸå§‹æ•¸å€¼ï¼Œç³»çµ±è‡ªå‹•å–å¹³å‡)",
            errorRowMsg: "âš ï¸ è¡Œæ•¸ä¸ç¬¦ï¼Œè«‹æª¢æŸ¥ã€‚",
            step3: "3. åƒæ•¸è¨­å®š",
            refGeneLabel: "é¸æ“‡å…§åƒåŸºå›  (Reference Genes)",
            deltaCtFormula: "ç”¨æ–¼è¨ˆç®— $\\Delta Ct = Ct_{Target} - \\text{Mean}(Ct_{Refs})$",
            multiRefNote: "* æ”¯æ´å¤šé‡å…§åƒï¼šè‹¥é¸æ“‡å¤šå€‹ï¼Œå°‡ä½¿ç”¨å…¶ Ct å€¼çš„ç®—è¡“å¹³å‡æ•¸ (ç­‰åŒæ–¼è¡¨ç¾é‡çš„å¹¾ä½•å¹³å‡) é€²è¡Œæ ¡æ­£ã€‚",
            controlKeyLabel: "å°ç…§çµ„é—œéµå­— (Control Keyword)",
            exactMatch: "å®Œå…¨ç¬¦åˆ (Exact Match) - ç”¨æ–¼ç²¾ç¢ºç¾¤çµ„æ¯”å° (å¦‚ \"WT\" vs \"WT-1\")",
            calibratorNote: "ç³»çµ±æœƒæ‰¾å‡ºç¬¦åˆæ­¤é—œéµå­—çš„æ¨£æœ¬ï¼Œ<br>ç®—å‡º <b>å¹³å‡ $\\Delta Ct$</b> ä½œç‚ºæ ¡æ­£åŸºæº– (Calibrator)ã€‚",
            startCalc: "é–‹å§‹è¨ˆç®—",
            step4: "4. åˆ†æçµæœ",
            exportCSV: "ğŸ“Š åŒ¯å‡º CSV (Excel)",
            colGene: "åŸºå› ",
            colSample: "æ¨£æœ¬",
            step5: "5. çµ±è¨ˆåˆ†æèˆ‡ä½œåœ– (Statistics & Plots)",
            btnExportStats: "åŒ¯å‡ºç•¶å‰åŸºå› çµ±è¨ˆ",
            btnExportAllStats: "åŒ¯å‡ºå…¨éƒ¨åŸºå› çµ±è¨ˆ",
            statNoteTitle: "ğŸ’¡ çµ±è¨ˆç§‘å­¸ä¿®æ­£èªªæ˜ï¼š",
            statNoteBody: "ç‚ºäº†ç¬¦åˆå¸¸æ…‹åˆ†ä½ˆå‡è¨­ï¼Œ<b>P å€¼è¨ˆç®—æ¡ç”¨ Î”Ct å€¼</b>ã€‚<br>3 çµ„ä»¥ä¸ŠåŸ·è¡Œ <b>ANOVA + Dunnett's Test</b> (èˆ‡ Control æ¯”è¼ƒ)ã€‚<br>åƒ… 2 çµ„æ™‚åŸ·è¡Œ <b>Welch's t-test</b> (ä¸å‡è¨­è®Šç•°æ•¸ç›¸ç­‰)ã€‚",
            multiGroupNote: "âš ï¸ æª¢æ¸¬åˆ°å¤šçµ„æ¯”è¼ƒ ({n} çµ„)ã€‚<br>å·²æ‡‰ç”¨ <b>Dunnett's Test</b> é€²è¡Œäº‹å¾Œæª¢å®š (Post-hoc)ã€‚",
            statPanelTitle: "çµ±è¨ˆæª¢å®šçµæœ (åŸºæ–¼ Î”Ct)",
            plotGeneLabel: "é¸æ“‡ç¹ªåœ–åŸºå› ï¼š",
            pVal: "På€¼",
            statSig: "é¡¯è‘—",
            statNs: "ä¸é¡¯è‘—",
            alertMinGene: "éŒ¯èª¤ï¼šåˆå§‹è‡³å°‘éœ€è¦ 2 å€‹åŸºå› ã€‚",
            alertConfirmClear: "ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å·²ç”Ÿæˆçš„å€å¡Šå—ï¼Ÿ\næ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼",
            alertBlockCount: "éŒ¯èª¤ï¼šç›®å‰åªæœ‰ {n} å€‹å€å¡Šã€‚\nåˆ†æè‡³å°‘éœ€è¦ 2 å€‹åŸºå›  (1å€‹å…§åƒ + 1å€‹ç›®æ¨™)ã€‚",
            alertRowMismatch: "éƒ¨åˆ†å€å¡Šçš„æ¨£æœ¬èˆ‡ Ct å€¼è¡Œæ•¸ä¸ä¸€è‡´ï¼Œè«‹æª¢æŸ¥ç´…è‰²éŒ¯èª¤ã€‚",
            alertValidGene: "æœ‰æ•ˆæ•¸æ“šçš„åŸºå› æ•¸é‡ä¸è¶³ 2 å€‹ï¼Œè«‹æª¢æŸ¥æ˜¯å¦æœ‰ç©ºç™½å€å¡Šã€‚",
            alertNoKeyword: "è«‹è¼¸å…¥å°ç…§çµ„é—œéµå­— (ä¾‹å¦‚ WT)ã€‚",
            alertNoCalibrator: "æ‰¾ä¸åˆ° {mode} \"{keyword}\" ä¸”è³‡æ–™å®Œæ•´çš„æ¨£æœ¬ï¼Œç„¡æ³•è¨ˆç®—åŸºæº–å€¼ã€‚",
            warnMissingRef: "âš ï¸ <b>è­¦å‘Šï¼š</b>ä»¥ä¸‹æ¨£æœ¬å› ç¼ºå°‘é¸å®šå…§åƒåŸºå›  ({ref}) çš„æ•¸æ“šï¼Œå·²è¢«æ’é™¤åœ¨è¨ˆç®—ä¹‹å¤–ï¼š<br>{samples}",
            calibInfo: "â„¹ï¸ å·²ä½¿ç”¨ {n} å€‹ \"{keyword}\" {mode} æ¨£æœ¬çš„å¹³å‡ Î”Ct ä½œç‚ºåŸºæº–",
            demoLoaded: "å·²è¼‰å…¥ç¯„ä¾‹ (åŒ…å« ACTB ä½œç‚ºç¬¬äºŒå…§åƒ)ï¼",
            placeholderKeyword: "ä¾‹å¦‚: WT",
            alertNoControlGroup: "éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç¬¦åˆã€Œå°ç…§çµ„é—œéµå­—ã€çš„åˆ†çµ„ã€‚è«‹æª¢æŸ¥é—œéµå­—æ˜¯å¦èˆ‡æ¨£æœ¬åç¨±ä¸€è‡´ã€‚",
            alertNoStats: "ç„¡çµ±è¨ˆæ•¸æ“šå¯åŒ¯å‡º",
            alertAllStatsNoRef: "è·³é {gene} (ç‚ºå…§åƒåŸºå› )",
            alertAllStatsError: "åŸºå›  {gene} ç„¡æ³•è¨ˆç®—: {msg}",
            anovaTitle: "å–®å› å­è®Šç•°æ•¸åˆ†æ (One-way ANOVA)",
            anovaSigMsg: "âœ… P = {p} < 0.05 (çµ„é–“æœ‰é¡¯è‘—å·®ç•°)",
            anovaNsMsg: "âš ï¸ P = {p} > 0.05 (çµ„é–“ç„¡é¡¯è‘—å·®ç•°)",
            anovaNsHint: "ç”±æ–¼ ANOVA ä¸é¡¯è‘—ï¼Œçµ±è¨ˆä¸Šä¸å»ºè­°é€²è¡Œå€‹åˆ¥çµ„é–“æ¯”è¼ƒ (Post-hoc test)ï¼Œè«‹è¬¹æ…è§£è®€ä»¥ä¸‹çµæœã€‚",
            alertSelectRef: "è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å…§åƒåŸºå› ï¼"
        },
        'en': {
            title: "ğŸ§¬ qPCR Analysis Tool 2^(-Î”Î”Ct)",
            langBtn: "ä¸­æ–‡",
            btnOffline: "Download Offline",
            step1: "1. Initial Setup",
            initGeneCount: "Initial Gene Count:",
            startBuild: "Generate Blocks",
            loadDemo: "[Load Demo Data]",
            minGeneNote: "* At least 2 genes required (1 Ref + 1 Target)",
            step2: "2. Data Entry",
            addBlock: "â• Add Block",
            clearBlocks: "ğŸ—‘ï¸ Clear All",
            dataInstr: "Enter Sample Names and Ct Values. Same names = Technical Replicates. Biological Replicates must have unique names (e.g., WT-1, WT-2).",
            nextStep: "Next: Parameters",
            geneNameLabel: "Gene Name:",
            sampleLabel: "â¬‡ï¸ Sample Names",
            ctLabel: "â¬‡ï¸ Ct Values",
            errorRowMsg: "âš ï¸ Row count mismatch.",
            step3: "3. Parameters",
            refGeneLabel: "Select Reference Genes",
            deltaCtFormula: "Calculates Î”Ct = Ct_Target - Mean(Ct_Refs)",
            multiRefNote: "* Multiple Reference Genes: If multiple are selected, the arithmetic mean of their Ct values (equivalent to the geometric mean of quantity) is used for normalization.",
            controlKeyLabel: "Control Group Keyword",
            exactMatch: "Exact Match (matches Group Name)",
            calibratorNote: "Finds samples matching this keyword, calculates Mean Î”Ct as Calibrator.",
            startCalc: "Calculate Results",
            step4: "4. Results",
            exportCSV: "ğŸ“Š Export CSV (Excel)",
            colGene: "Gene",
            colSample: "Sample",
            step5: "5. Statistics & Plots",
            btnExportStats: "Export Current Gene Stats",
            btnExportAllStats: "Export All Genes Stats",
            statNoteTitle: "ğŸ’¡ Statistics Note:",
            statNoteBody: "<b>P-values are calculated using Î”Ct</b> to meet normality assumptions. <br><b>One-way ANOVA + Dunnett's Test</b> is used for 3+ groups.<br><b>Welch's t-test</b> is used for 2 groups comparison.",
            multiGroupNote: "âš ï¸ Multiple comparisons detected ({n} groups).<br><b>Dunnett's Test</b> applied for post-hoc analysis.",
            statPanelTitle: "Statistical Test (Based on Î”Ct)",
            plotGeneLabel: "Select Gene for Plot:",
            pVal: "P-value",
            statSig: "Significant",
            statNs: "Not Significant",
            alertMinGene: "Error: At least 2 genes required.",
            alertConfirmClear: "Are you sure you want to clear all?",
            alertBlockCount: "Error: Only {n} blocks found.",
            alertRowMismatch: "Row count mismatch.",
            alertValidGene: "Less than 2 valid genes.",
            alertNoKeyword: "Please enter Control Keyword.",
            alertNoCalibrator: "No valid control samples found.",
            warnMissingRef: "âš ï¸ <b>Warning:</b> The following samples are excluded due to missing selected Reference Gene ({ref}) data:<br>{samples}",
            calibInfo: "â„¹ï¸ Used {n} \"{keyword}\" samples as Calibrator",
            demoLoaded: "Demo Loaded (includes ACTB as 2nd ref)!",
            placeholderKeyword: "e.g., WT",
            alertNoControlGroup: "Error: No group matches the Control Keyword. Please check if the keyword matches sample names.",
            alertNoStats: "No stats data available",
            alertAllStatsNoRef: "Skipping {gene} (Ref Gene)",
            alertAllStatsError: "Gene {gene} error: {msg}",
            anovaTitle: "One-way ANOVA",
            anovaSigMsg: "âœ… P = {p} < 0.05 (Significant Difference)",
            anovaNsMsg: "âš ï¸ P = {p} > 0.05 (No Significant Difference)",
            anovaNsHint: "Since ANOVA is not significant, pairwise comparisons are not recommended. Please interpret results below with caution.",
            alertSelectRef: "Please select at least one reference gene!"
        }
    };

    function toggleLanguage() {
        currentLang = currentLang === 'zh' ? 'en' : 'zh';
        updateTexts();
    }

    function t(key) {
        return translations[currentLang][key] || key;
    }

    function updateTexts() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if(translations[currentLang][key]) {
                el.innerHTML = translations[currentLang][key]; 
            }
        });
        document.getElementById('langText').innerText = translations[currentLang]['langBtn'];
        const keyInput = document.getElementById('controlKeyword');
        if(keyInput) keyInput.placeholder = t('placeholderKeyword');
        
        if(!document.getElementById('statsSection').classList.contains('hidden')) {
             updatePlot();
        }
        
        const infoEl = document.getElementById('calibratorInfo');
        if (infoEl) {
            const savedN = infoEl.getAttribute('data-n');
            const savedKw = infoEl.getAttribute('data-kw');
            if (savedN && savedKw) {
                const matchModeText = document.getElementById('exactMatchCheckbox').checked ? 
                    t('modeExact') : t('modeContains');
                infoEl.innerText = t('calibInfo')
                    .replace('{n}', savedN)
                    .replace('{keyword}', savedKw)
                    .replace('{mode}', matchModeText);
            }
        }

        const warningEl = document.getElementById('warningBox');
        if (warningEl && warningEl.style.display !== 'none') {
            const missingSamples = warningEl.getAttribute('data-missing-samples');
            const refGene = warningEl.getAttribute('data-ref-gene');
            
            if (missingSamples && refGene) {
                const msg = t('warnMissingRef')
                    .replace('{ref}', refGene)
                    .replace('{samples}', missingSamples);
                warningEl.innerHTML = msg;
            }
        }
    }

    // --- æ ¸å¿ƒè®Šæ•¸ ---
    let GLOBAL_DATA = {}; 
    let GENE_LIST = [];
    let SAMPLE_LIST = new Set();
    let FOLD_CHANGE_DATA = []; 
    let blockCounter = 0; 
    let CURRENT_STATS_EXPORT_DATA = []; 
    let CURRENT_ANOVA_RESULT = null;

    function getGroupName(sampleName) {
        return sampleName.replace(/[-_ ]\d+$/, ''); 
    }

    // --- 1. å»ºç«‹ç•Œé¢èˆ‡æ•¸æ“šè¼¸å…¥ ---
    function generateGeneBlocks() {
        const countInput = document.getElementById('geneCountInput');
        let count = parseInt(countInput.value) || 0;
        if (count < 2) { alert(t('alertMinGene')); return; }

        const container = document.getElementById('geneBlocksContainer');
        container.innerHTML = ''; 
        blockCounter = 0;

        for (let i = 0; i < count; i++) { addSingleBlock(true); }
        showStep(2);
    }

    function addSingleBlock(isAuto = false) {
        blockCounter++;
        const container = document.getElementById('geneBlocksContainer');
        const id = `block_${Date.now()}_${blockCounter}`; 
        const currentCount = container.children.length + 1;

        const html = `
            <div class="gene-block" id="${id}">
                <button type="button" class="delete-block-btn" onclick="removeBlock('${id}')" title="Delete">âœ•</button>
                <div class="gene-header">
                    <label data-i18n="geneNameLabel">${t('geneNameLabel')}</label>
                    <input type="text" class="gene-name-input" value="Gene ${currentCount}">
                </div>
                <div class="input-row">
                    <div class="input-col">
                        <label data-i18n="sampleLabel">${t('sampleLabel')}</label>
                        <textarea class="samples-input" placeholder="WT-1\nWT-2\nTreat-1..."></textarea>
                    </div>
                    <div class="input-col">
                        <label data-i18n="ctLabel">${t('ctLabel')}</label>
                        <textarea class="cts-input" placeholder="22.5\n22.8\n24.0..."></textarea>
                    </div>
                </div>
                <div class="error-msg" data-i18n="errorRowMsg" style="display:none;">${t('errorRowMsg')}</div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
        if (!isAuto) {
             setTimeout(() => { document.getElementById(id)?.scrollIntoView({behavior: "smooth", block: "center"}); }, 100);
        }
    }

    function removeBlock(id) { document.getElementById(id)?.remove(); }
    function clearAllBlocks() {
        if(confirm(t('alertConfirmClear'))) {
            document.getElementById('geneBlocksContainer').innerHTML = '';
            blockCounter = 0; 
        }
    }

    function showStep(step) {
        if(step === 2) {
            document.getElementById('dataEntrySection').classList.remove('hidden');
            document.getElementById('settingsSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('statsSection').classList.add('hidden');
            document.getElementById('dataEntrySection').scrollIntoView({behavior: "smooth"});
        }
    }

    function processData() {
        GLOBAL_DATA = {};
        GENE_LIST = [];
        SAMPLE_LIST = new Set();
        let hasError = false;

        const blocks = document.querySelectorAll('.gene-block');
        if (blocks.length < 2) { alert(t('alertBlockCount').replace('{n}', blocks.length)); return; }

        blocks.forEach((block) => {
            const geneName = block.querySelector('.gene-name-input').value.trim();
            const sampleText = block.querySelector('.samples-input').value.trim();
            const ctText = block.querySelector('.cts-input').value.trim();
            const errorMsg = block.querySelector('.error-msg');

            const samples = sampleText.split(/[\n\r]+/).map(s => s.trim()).filter(s => s);
            const cts = ctText.split(/[\n\r]+/).map(c => c.trim()).filter(c => c);

            if (samples.length !== cts.length) {
                errorMsg.style.display = 'block';
                hasError = true;
                return; 
            }
            errorMsg.style.display = 'none';
            if (samples.length === 0) return; 

            if (!GENE_LIST.includes(geneName)) GENE_LIST.push(geneName);

            for(let i=0; i<samples.length; i++) {
                const sName = samples[i];
                const ctVal = parseFloat(cts[i]);
                if (!isNaN(ctVal)) {
                    SAMPLE_LIST.add(sName);
                    if (!GLOBAL_DATA[sName]) GLOBAL_DATA[sName] = {};
                    if (!GLOBAL_DATA[sName][geneName]) GLOBAL_DATA[sName][geneName] = [];
                    GLOBAL_DATA[sName][geneName].push(ctVal);
                }
            }
        });

        if (hasError) { alert(t('alertRowMismatch')); return; }
        if (GENE_LIST.length < 2) { alert(t('alertValidGene')); return; }

        populateSettings();
        document.getElementById('settingsSection').classList.remove('hidden');
        document.getElementById('settingsSection').scrollIntoView({behavior: "smooth"});
    }

    function populateSettings() {
        const container = document.getElementById('refGeneSelectContainer');
        container.innerHTML = '';
        
        GENE_LIST.forEach(g => {
            const div = document.createElement('div');
            div.className = 'checkbox-item';
            
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.id = `ref_${g}`;
            input.value = g;
            input.name = 'refGene';
            
            // é è¨­å‹¾é¸å¸¸è¦‹å…§åƒ
            if (['GAPDH', 'ACTB', '18S'].includes(g.toUpperCase())) {
                input.checked = true;
            }
            
            const label = document.createElement('label');
            label.htmlFor = `ref_${g}`;
            label.innerText = g;
            
            div.appendChild(input);
            div.appendChild(label);
            container.appendChild(div);
        });
    }

    // --- 2. è¨ˆç®—é‚è¼¯ ---
    function calculateResults() {
        const checkboxes = document.querySelectorAll('input[name="refGene"]:checked');
        const selectedRefs = Array.from(checkboxes).map(cb => cb.value);
        
        const ctrlKeyword = document.getElementById('controlKeyword').value.trim();
        const useExactMatch = document.getElementById('exactMatchCheckbox').checked; 

        if (selectedRefs.length === 0) { alert(t('alertSelectRef')); return; }
        if (!ctrlKeyword) { alert(t('alertNoKeyword')); return; }

        const tbody = document.querySelector('#resultTable tbody');
        tbody.innerHTML = '';
        FOLD_CHANGE_DATA = []; 
        
        // A. è¨ˆç®—æ¯å€‹æ¨£æœ¬çš„ Composite Reference Ct (ç®—è¡“å¹³å‡)
        let sampleStats = {}; 
        let missingRefSamples = [];
        
        SAMPLE_LIST.forEach(sName => {
            // æª¢æŸ¥è©²æ¨£æœ¬æ˜¯å¦æ“æœ‰ "æ‰€æœ‰" é¸å®šå…§åƒçš„æ•¸æ“š
            let refCts = [];
            let isMissing = false;
            
            for (let ref of selectedRefs) {
                if (!GLOBAL_DATA[sName][ref] || GLOBAL_DATA[sName][ref].length === 0) {
                    isMissing = true;
                    break;
                }
                refCts.push(getMean(GLOBAL_DATA[sName][ref]));
            }
            
            if (isMissing) {
                missingRefSamples.push(sName);
                return;
            }
            
            // è¨ˆç®—å…§åƒå¹³å‡ Ct (Composite Reference)
            // ç®—è¡“å¹³å‡ Ct = å¹¾ä½•å¹³å‡ Quantity
            const compositeRefCt = getMean(refCts);
            
            sampleStats[sName] = {};
            
            GENE_LIST.forEach(gName => {
                // å¦‚æœæ˜¯ç›®æ¨™åŸºå›  (æˆ–è€…æ˜¯å…§åƒåŸºå› æœ¬èº«ï¼Œä¹Ÿç®—ä¸€ä¸‹ Delta Ct ä¾›åƒè€ƒ)
                if (GLOBAL_DATA[sName][gName]) {
                    const targetMean = getMean(GLOBAL_DATA[sName][gName]);
                    sampleStats[sName][gName] = { 
                        meanCt: targetMean, 
                        deltaCt: targetMean - compositeRefCt 
                    };
                }
            });
        });

        // è­¦å‘Šè™•ç†
        const warningEl = document.getElementById('warningBox');
        if (missingRefSamples.length > 0) {
            warningEl.setAttribute('data-missing-samples', missingRefSamples.join(', '));
            warningEl.setAttribute('data-ref-gene', selectedRefs.join('+')); // ç”¨ + è™Ÿé€£æ¥å¤šå€‹å…§åƒ
            const msg = t('warnMissingRef')
                .replace('{ref}', selectedRefs.join('+'))
                .replace('{samples}', missingRefSamples.join(', '));
            warningEl.innerHTML = msg;
            warningEl.style.display = 'block';
        } else {
            warningEl.style.display = 'none';
        }

        // B. è¨ˆç®— Calibrator (Control Group çš„å¹³å‡ Delta Ct)
        let calibrators = {}; 
        let controlCount = 0; 
        
        SAMPLE_LIST.forEach(sName => {
            const groupName = getGroupName(sName);
            const isMatch = useExactMatch ? (groupName === ctrlKeyword) : sName.includes(ctrlKeyword);
            
            // ç¢ºä¿è©²æ¨£æœ¬æœ‰æ•ˆ (æœ‰ sampleStats)
            if (isMatch && sampleStats[sName]) { controlCount++; }
        });

        GENE_LIST.forEach(gName => {
            let sumDelta = 0, count = 0;
            SAMPLE_LIST.forEach(sName => {
                const groupName = getGroupName(sName);
                const isMatch = useExactMatch ? (groupName === ctrlKeyword) : sName.includes(ctrlKeyword);
                
                if (isMatch && sampleStats[sName] && sampleStats[sName][gName]) {
                    sumDelta += sampleStats[sName][gName].deltaCt;
                    count++;
                }
            });
            if (count > 0) calibrators[gName] = sumDelta / count;
        });

        if (Object.keys(calibrators).length === 0) {
            const matchMsg = useExactMatch ? t('modeExact') : t('modeContains');
            alert(t('alertNoCalibrator').replace('{mode}', matchMsg).replace('{keyword}', ctrlKeyword));
            return;
        }

        // C. æ¸²æŸ“è¡¨æ ¼
        const sortedSamples = Array.from(SAMPLE_LIST).sort((a, b) => 
            a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
        );
        
        let lastGene = "";
        GENE_LIST.forEach(gName => {
            const calibDelta = calibrators[gName];
            sortedSamples.forEach(sName => {
                if (!sampleStats[sName] || !sampleStats[sName][gName]) return;

                const stats = sampleStats[sName][gName];
                let ddCt = null;
                let foldChange = null;

                if (calibDelta !== undefined) {
                    ddCt = stats.deltaCt - calibDelta;
                    foldChange = Math.pow(2, -ddCt);
                    
                    // åªæœ‰ç•¶æ­¤åŸºå›  "ä¸å®Œå…¨ç­‰æ–¼" å…§åƒçµ„åˆæ™‚æ‰åŠ å…¥çµ±è¨ˆ
                    // ä½†é€šå¸¸æˆ‘å€‘æƒ³çœ‹æ‰€æœ‰éå…§åƒåŸºå› ï¼Œæˆ–è€…ç”šè‡³æƒ³çœ‹å…§åƒæœ¬èº«çš„ç©©å®šæ€§
                    // é€™è£¡é‚è¼¯ï¼šåªè¦ä¸æ˜¯è¢«é¸ä¸­çš„å…§åƒä¹‹ä¸€ï¼Œå°±åŠ å…¥ FOLD_CHANGE_DATA
                    if (!selectedRefs.includes(gName)) {
                        FOLD_CHANGE_DATA.push({
                            gene: gName,
                            sample: sName,
                            foldChange: foldChange,
                            deltaCt: stats.deltaCt 
                        });
                    }
                }

                const tr = document.createElement('tr');
                if (gName !== lastGene && lastGene !== "") tr.classList.add('gene-separator');
                lastGene = gName;

                tr.innerHTML = `
                    <td style="font-weight:bold;">${gName}</td>
                    <td>${sName}</td>
                    <td>${stats.meanCt.toFixed(4)}</td>
                    <td style="color:#666">${stats.deltaCt.toFixed(4)}</td>
                    <td>${ddCt !== null ? ddCt.toFixed(4) : '-'}</td>
                    <td style="font-weight:bold; color:${foldChange > 1.5 ? '#c0392b' : '#2c3e50'}">
                        ${foldChange !== null ? foldChange.toFixed(4) : '-'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        });

        const infoEl = document.getElementById('calibratorInfo');
        infoEl.setAttribute('data-n', controlCount);
        infoEl.setAttribute('data-kw', ctrlKeyword);
        const matchModeText = useExactMatch ? t('modeExact') : t('modeContains');
        infoEl.innerText = t('calibInfo').replace('{n}', controlCount).replace('{keyword}', ctrlKeyword).replace('{mode}', matchModeText);
        
        document.getElementById('resultSection').classList.remove('hidden');
        document.getElementById('statsSection').classList.remove('hidden');
        initStatsSection();
        document.getElementById('resultSection').scrollIntoView({behavior: "smooth"});
    }

    // --- 3. çµ±è¨ˆèˆ‡ç¹ªåœ– (æ ¸å¿ƒé‚è¼¯: ANOVA + Dunnett / T-test) ---

    function initStatsSection() {
        const select = document.getElementById('plotGeneSelect');
        const checkboxes = document.querySelectorAll('input[name="refGene"]:checked');
        const selectedRefs = Array.from(checkboxes).map(cb => cb.value);
        
        select.innerHTML = '';
        GENE_LIST.forEach(g => {
            // æ’é™¤å·²é¸ç‚ºå…§åƒçš„åŸºå› 
            if (!selectedRefs.includes(g)) {
                const opt = document.createElement('option');
                opt.value = g; opt.innerText = g;
                select.appendChild(opt);
            }
        });
        updatePlot();
    }

    function calculateGeneStats(targetGene) {
        const ctrlKeyword = document.getElementById('controlKeyword').value.trim();
        const useExactMatch = document.getElementById('exactMatchCheckbox').checked;

        // 1. æ•´ç†æ•¸æ“š
        let groupsFC = {};     
        let groupsDeltaCt = {}; 
        
        FOLD_CHANGE_DATA.forEach(d => {
            if (d.gene === targetGene) {
                const grpName = getGroupName(d.sample);
                if (!groupsFC[grpName]) groupsFC[grpName] = [];
                groupsFC[grpName].push(d.foldChange);
                if (!groupsDeltaCt[grpName]) groupsDeltaCt[grpName] = [];
                groupsDeltaCt[grpName].push(d.deltaCt);
            }
        });

        let groupNames = Object.keys(groupsFC).sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));
        const controlGroupMatch = groupNames.find(g => useExactMatch ? g === ctrlKeyword : g.includes(ctrlKeyword));
        
        if (!controlGroupMatch) return { error: `âŒ ${t('alertNoControlGroup')}` };

        const controlGroup = controlGroupMatch;
        groupNames = [controlGroup, ...groupNames.filter(g => g !== controlGroup)];

        let anovaDataArrays = [];
        groupNames.forEach(g => {
            if(groupsDeltaCt[g] && groupsDeltaCt[g].length >= 2) anovaDataArrays.push(groupsDeltaCt[g]);
        });

        let anovaP = null;
        if (groupNames.length > 2) {
             try {
                if (anovaDataArrays.length === groupNames.length) {
                    anovaP = jStat.anovaftest(...anovaDataArrays);
                }
             } catch(e) { console.error(e); }
        }

        const comparisonCount = groupNames.length - 1; 
        const ctrlDeltaCtData = groupsDeltaCt[controlGroup];
        let results = [];
        let mse = 0; 
        let dfError = 0;

        if (groupNames.length > 2) {
             const mseData = calculateMSE(groupsDeltaCt);
             mse = mseData.mse;
             dfError = mseData.dfError;
        }

        groupNames.forEach(grp => {
            if (grp === controlGroup) return;
            
            const fcData = groupsFC[grp];
            const expDeltaCt = groupsDeltaCt[grp];
            
            let statObj = {
                comparison: `${grp} vs ${controlGroup}`,
                grp: grp,
                ctrl: controlGroup,
                nExp: expDeltaCt ? expDeltaCt.length : 0,
                nCtrl: ctrlDeltaCtData ? ctrlDeltaCtData.length : 0,
                meanFC: getMean(fcData),
                ctrlMeanFC: getMean(groupsFC[controlGroup]),
                semFC: calculateStandardError(fcData),
                ctrlSemFC: calculateStandardError(groupsFC[controlGroup]),
                pRaw: 1.0,
                pAdj: "ns", // Default display text
                sig: 'ns',
                method: 'none',
                isExactP: false // Flag to control display logic
            };

            if (ctrlDeltaCtData && ctrlDeltaCtData.length > 1 && expDeltaCt && expDeltaCt.length > 1) {
                // Always calculate Raw P (Welch) for reference
                const pRawValue = twoSampleTtest(expDeltaCt, ctrlDeltaCtData);
                statObj.pRaw = pRawValue;

                if (groupNames.length === 2) {
                    // Method: Welch's t-test (2 groups)
                    statObj.pAdj = pRawValue.toFixed(6); 
                    statObj.sig = getStars(pRawValue);
                    statObj.method = 'Welch\'s t-test';
                    statObj.isExactP = true;
                } else {
                    // Method: Dunnett's Test (3+ groups) - Lookup Table
                    const meanExp = getMean(expDeltaCt);
                    const meanCtrl = getMean(ctrlDeltaCtData);
                    const diff = Math.abs(meanExp - meanCtrl);
                    
                    // æŸ¥è¡¨å–å¾— 0.05, 0.01, 0.001 çš„ d å€¼
                    const dVal_05 = getCriticalValue(DUNNETT_D_TABLE_05, groupNames.length, dfError);
                    const dVal_01 = getCriticalValue(DUNNETT_D_TABLE_01, groupNames.length, dfError);
                    const dVal_001 = getCriticalValue(DUNNETT_D_TABLE_001, groupNames.length, dfError);
                    
                    if (dVal_05 && mse > 0) {
                        const stdErrDiff = Math.sqrt(mse * (1/statObj.nExp + 1/statObj.nCtrl));
                        const cd_05 = dVal_05 * stdErrDiff;
                        const cd_01 = (dVal_01) ? dVal_01 * stdErrDiff : 999999;
                        const cd_001 = (dVal_001) ? dVal_001 * stdErrDiff : 999999;
                        
                        // ANOVA Gate
                        if (anovaP !== null && anovaP >= 0.05) {
                            statObj.sig = 'ns';
                            statObj.pAdj = '> 0.05 (ns)';
                        } else {
                            if (diff > cd_001) {
                                statObj.sig = '***';
                                statObj.pAdj = '< 0.001';
                                statObj.dunnettInfo = `Diff: ${diff.toFixed(3)} > CD001: ${cd_001.toFixed(3)}`;
                            } else if (diff > cd_01) {
                                statObj.sig = '**';
                                statObj.pAdj = '< 0.01';
                                statObj.dunnettInfo = `Diff: ${diff.toFixed(3)} > CD01: ${cd_01.toFixed(3)}`;
                            } else if (diff > cd_05) {
                                statObj.sig = '*';
                                statObj.pAdj = '< 0.05';
                                statObj.dunnettInfo = `Diff: ${diff.toFixed(3)} > CD05: ${cd_05.toFixed(3)}`;
                            } else {
                                statObj.sig = 'ns';
                                statObj.pAdj = '> 0.05';
                                statObj.dunnettInfo = `Diff: ${diff.toFixed(3)} < CD05`;
                            }
                        }
                        statObj.method = 'Dunnett\'s Test';
                        statObj.isExactP = false;
                    } else {
                        statObj.error = "Stats Error";
                    }
                }
            } else {
                statObj.error = "N<2";
            }
            results.push(statObj);
        });

        return { 
            results: results, 
            groupsFC: groupsFC, 
            groupNames: groupNames, 
            comparisonCount: comparisonCount,
            controlGroup: controlGroup,
            anovaP: anovaP
        };
    }

    function updatePlot() {
        const targetGene = document.getElementById('plotGeneSelect').value;
        if (!targetGene) return;

        const analysis = calculateGeneStats(targetGene);
        
        if (analysis.error) {
            document.getElementById('statResultsContainer').innerHTML = "";
            document.getElementById('plotlyChart').innerHTML = `<div style="text-align:center;color:red;padding:20px;">${analysis.error}</div>`;
            return;
        }

        const { results, groupsFC, groupNames, comparisonCount, anovaP } = analysis;
        
        CURRENT_STATS_EXPORT_DATA = results.map(r => ({ ...r, targetGene: targetGene, anovaP: anovaP }));
        CURRENT_ANOVA_RESULT = anovaP;

        let finalHTML = "";

        // 1. ANOVA Block
        if (anovaP !== null) {
            const isAnovaSig = anovaP < 0.05;
            const msg = isAnovaSig ? t('anovaSigMsg').replace('{p}', anovaP.toFixed(6)) : t('anovaNsMsg').replace('{p}', anovaP.toFixed(6));
            const cssClass = isAnovaSig ? 'anova-pass' : 'anova-fail';
            
            finalHTML += `
                <div class="anova-result-box ${cssClass}">
                    <strong>${t('anovaTitle')}</strong><br>
                    <span style="font-size:1.1em">${msg}</span>
                    ${!isAnovaSig ? `<br><div style='margin-top:5px; font-size:0.9em; opacity:0.85;'>${t('anovaNsHint')}</div>` : ''}
                </div>
            `;
        }
        
        // 2. Dunnett Warning Block
        if (comparisonCount > 1) {
            const warnText = t('multiGroupNote').replace('{n}', comparisonCount + 1);
            finalHTML += `<div style="background:#fff8e1; color:#856404; padding:8px; border-radius:4px; font-size:0.9em; margin-bottom:15px; border:1px solid #ffeeba;">${warnText}</div>`;
        }
        
        // 3. Results List
        results.forEach(stat => {
            if (stat.error) {
                finalHTML += `<div class="stat-item">${stat.grp}: N<2, ç„¡æ³•æª¢å®š</div>`;
            } else {
                const isSig = stat.sig !== 'ns';
                // Logic to display exact P or Range
                let pDisplay = "";
                if (stat.isExactP) {
                    // 2 groups (Welch) -> Exact P
                    pDisplay = `Result (P): <span class="${isSig ? 'stat-sig' : ''}">${stat.pAdj}</span>`;
                } else {
                    // 3+ groups (Dunnett) -> Range + Raw Reference
                    // Display stars based on significance
                    let starHtml = '';
                    if (stat.sig === '***') starHtml = ' (***)';
                    else if (stat.sig === '**') starHtml = ' (**)';
                    else if (stat.sig === '*') starHtml = ' (*)';
                    
                    pDisplay = `
                        Result: <span class="${isSig ? 'stat-sig' : ''}">${stat.pAdj}</span> <span style="font-weight:bold">${starHtml}</span>
                        <br><span style="color:#666; font-size:0.9em;">(Raw T-test P: ${stat.pRaw.toFixed(6)})</span>
                    `;
                }

                finalHTML += `
                    <div class="stat-item">
                        <div><b>${stat.comparison}</b></div>
                        <div style="font-size:0.9em; color:#555;">(n=${stat.nExp} vs n=${stat.nCtrl})</div>
                        <div style="margin-top:5px;">${pDisplay}</div>
                        <div class="stat-method">Method: ${stat.method}</div>
                        ${stat.dunnettInfo ? `<div style="font-size:0.8em; color:#999;">${stat.dunnettInfo}</div>` : ''}
                    </div>
                `;
            }
        });

        document.getElementById('statResultsContainer').innerHTML = finalHTML || "ç„¡æ•¸æ“š";

        // --- ç¹ªåœ– ---
        let annotations = [];
        const showStars = (anovaP === null) || (anovaP < 0.05);

        if (showStars) {
            results.forEach(stat => {
                if (!stat.error) {
                    const yPos = Math.max(0, stat.meanFC) + stat.semFC + (Math.max(0.1, stat.meanFC) * 0.15);
                    annotations.push({
                        x: stat.grp, y: yPos, text: stat.sig,
                        xanchor: 'center', yanchor: 'bottom', showarrow: false,
                        font: { size: 16, color: stat.sig !== 'ns' ? '#e74c3c' : '#7f8c8d' }
                    });
                }
            });
        }

        const xData = []; const yMean = []; const yError = [];
        groupNames.forEach(grp => {
            xData.push(grp);
            yMean.push(getMean(groupsFC[grp]));
            yError.push(calculateStandardError(groupsFC[grp]));
        });

        const traceBar = {
            x: xData, y: yMean, type: 'bar', name: 'Mean Â± SEM',
            marker: { color: 'rgba(52, 152, 219, 0.7)' },
            error_y: { type: 'data', array: yError, visible: true, color: '#2c3e50' }
        };

        const layout = {
            title: `Relative Expression: ${targetGene}`,
            yaxis: { title: 'Fold Change (2^-Î”Î”Ct)' },
            annotations: annotations, 
            showlegend: false,
            template: 'plotly_white',
            margin: { t: 50, b: 50, l: 60, r: 20 }
        };

        Plotly.newPlot('plotlyChart', [traceBar], layout, {responsive: true});
    }

    // --- è¼”åŠ©è¨ˆç®—å‡½æ•¸ ---
    function calculateMSE(groupsData) {
        let sse = 0;
        let totalDF = 0;
        for (let grp in groupsData) {
            const vals = groupsData[grp];
            const n = vals.length;
            if (n < 2) continue;
            const mean = vals.reduce((a, b) => a + b, 0) / n;
            sse += vals.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0);
            totalDF += (n - 1);
        }
        return { mse: (totalDF === 0) ? 0 : sse / totalDF, dfError: totalDF };
    }

    function getCriticalValue(table, k, df) {
        const definedKs = Object.keys(table).map(Number).sort((a, b) => a - b);
        if (k > definedKs[definedKs.length - 1]) return table[definedKs[definedKs.length - 1]];
        
        let targetK = k;
        if (!table[k]) {
            for (let i = 0; i < definedKs.length; i++) {
                if (definedKs[i] > k) { targetK = definedKs[i]; break; }
            }
        }
        
        const dfTable = table[targetK];
        const definedDFs = Object.keys(dfTable).map(Number).sort((a, b) => a - b);
        if (df >= definedDFs[definedDFs.length - 1]) return dfTable[definedDFs[definedDFs.length - 1]];
        
        for (let i = 0; i < definedDFs.length; i++) {
            if (definedDFs[i] > df) { return dfTable[definedDFs[i - 1]]; }
        }
        return dfTable[definedDFs[0]];
    }

    function getMean(arr) { return arr && arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0; }
    
    function calculateStandardError(values) {
        if (!values || values.length < 2) return 0;
        const mean = getMean(values);
        const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / (values.length - 1);
        return Math.sqrt(variance) / Math.sqrt(values.length);
    }

    function twoSampleTtest(sample1, sample2) {
        const n1 = sample1.length, n2 = sample2.length;
        if(n1 < 2 || n2 < 2) return 1.0; 
        const m1 = jStat.mean(sample1), m2 = jStat.mean(sample2);
        const v1 = jStat.variance(sample1), v2 = jStat.variance(sample2);
        const vn1 = v1 / n1, vn2 = v2 / n2; 
        const se = Math.sqrt(vn1 + vn2);
        if (se === 0) return (m1 === m2) ? 1.0 : 0.0;
        const tStat = (m1 - m2) / se;
        const df = Math.pow(vn1 + vn2, 2) / ((Math.pow(vn1, 2) / (n1 - 1)) + (Math.pow(vn2, 2) / (n2 - 1)));
        return (1 - jStat.studentt.cdf(Math.abs(tStat), df)) * 2;
    }

    function getStars(p) {
        if (p < 0.001) return '***';
        if (p < 0.01) return '**';
        if (p < 0.05) return '*';
        return 'ns';
    }

    // --- åŒ¯å‡ºåŠŸèƒ½ ---
    function exportCSV() {
        let csv = "\uFEFFGene,Sample,Raw Ct Values,Mean Ct,Delta Ct,ddCt,Fold Change\n";
        document.querySelectorAll('#resultTable tbody tr').forEach(tr => {
            const cells = tr.querySelectorAll('td');
            if (cells.length === 0) return;
            const sample = cells[1].innerText, gene = cells[0].innerText;
            const raw = GLOBAL_DATA[sample] && GLOBAL_DATA[sample][gene] ? GLOBAL_DATA[sample][gene].join(";") : "";
            csv += [`"${gene}"`, `"${sample}"`, `"${raw}"`, cells[2].innerText, cells[3].innerText, cells[4].innerText, cells[5].innerText].join(",") + "\n";
        });
        downloadBlob(csv, "qpcr_results.csv");
    }
    
    function exportStatsCSV() {
        if (!CURRENT_STATS_EXPORT_DATA.length) { alert(t('alertNoStats')); return; }
        downloadStatsCSV(CURRENT_STATS_EXPORT_DATA, `qpcr_stats_${CURRENT_STATS_EXPORT_DATA[0].targetGene}.csv`);
    }

    function exportAllStatsCSV() {
        const checkboxes = document.querySelectorAll('input[name="refGene"]:checked');
        const selectedRefs = Array.from(checkboxes).map(cb => cb.value);
        let allStats = [];
        
        GENE_LIST.forEach(gene => {
            // è·³éæ‰€æœ‰è¢«é¸ç‚ºå…§åƒçš„åŸºå› 
            if (selectedRefs.includes(gene)) return;
            const analysis = calculateGeneStats(gene);
            if (!analysis.error) {
                allStats = allStats.concat(analysis.results.map(r => ({ ...r, targetGene: gene, anovaP: analysis.anovaP })));
            }
        });
        if (allStats.length === 0) { alert(t('alertNoStats')); return; }
        downloadStatsCSV(allStats, "qpcr_stats_ALL.csv");
    }

    function downloadStatsCSV(data, filename) {
        let csv = "\uFEFFTarget_Gene,ANOVA_P,Comparison,Group_N,Ctrl_N,Mean_FC,Ctrl_Mean_FC,Sig,Method\n";
        data.forEach(d => {
            csv += [d.targetGene, d.anovaP!==null?d.anovaP.toFixed(6):"NA", d.comparison, d.nExp, d.nCtrl, d.meanFC.toFixed(4), d.ctrlMeanFC.toFixed(4), d.sig, d.method].join(",") + "\n";
        });
        downloadBlob(csv, filename);
    }

    function downloadBlob(content, filename) {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([content], { type: 'text/csv;charset=utf-8;' }));
        link.download = filename;
        link.click();
    }

    function loadDemoData() {
        document.getElementById('geneCountInput').value = 4; // æ›´æ–°ç‚º 4 å€‹åŸºå›  (GAPDH, ACTB, IL6, IL17)
        generateGeneBlocks();
        const samples = "WT-1\nWT-2\nWT-3\nTreatA-1\nTreatA-2\nTreatA-3\nTreatB-1\nTreatB-2\nTreatB-3";
        setTimeout(() => {
            const blocks = document.querySelectorAll('.gene-block');
            if(blocks.length >= 4) {
                // Ref 1: GAPDH
                blocks[0].querySelector('.gene-name-input').value = "GAPDH";
                blocks[0].querySelector('.samples-input').value = samples;
                blocks[0].querySelector('.cts-input').value = "22.5\n22.4\n22.6\n22.5\n22.8\n22.7\n22.6\n22.5\n22.8";
                
                // Ref 2: ACTB (æ–°å¢)
                blocks[1].querySelector('.gene-name-input').value = "ACTB";
                blocks[1].querySelector('.samples-input').value = samples;
                blocks[1].querySelector('.cts-input').value = "24.1\n24.0\n24.2\n24.1\n24.3\n24.2\n24.0\n24.1\n24.2";

                // Target 1: IL6
                blocks[2].querySelector('.gene-name-input').value = "IL6";
                blocks[2].querySelector('.samples-input').value = samples;
                blocks[2].querySelector('.cts-input').value = "30.5\n30.4\n30.6\n27.5\n27.1\n27.9\n28.5\n28.9\n28.2";

                // Target 2: IL17
                blocks[3].querySelector('.gene-name-input').value = "IL17";
                blocks[3].querySelector('.samples-input').value = samples;
                blocks[3].querySelector('.cts-input').value = "30.7\n30.2\n30.4\n28.5\n28.8\n28.2\n29.1\n28.8\n28.3";
            }
            document.getElementById('controlKeyword').value = "WT";
            alert(t('demoLoaded'));
        }, 100);
    }
</script>
</body>
</html>