<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>qPCR åˆ†æå·¥å…· / qPCR Analysis Tool</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jstat@1.9.6/dist/jstat.min.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --bg: #f4f6f9;
            --card-bg: #ffffff;
            --excel-green: #217346;
            --excel-dark: #14442a;
        }

        body {
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--primary);
            line-height: 1.5;
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 1200px; margin: 0 auto; position: relative; }
        
        .header-row {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin-bottom: 30px;
        }
        h1 { margin: 0; text-align: center; }

        .header-controls {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 10px;
        }

        .top-btn {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 5px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
            line-height: normal;
        }
        .top-btn:hover { background: var(--accent); color: white; }

        .card {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e1e4e8;
        }

        .step-title {
            font-size: 1.2em;
            font-weight: 700;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .gene-block {
            background-color: #fafbfc;
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .gene-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding-right: 40px;
        }

        .gene-name-input {
            font-size: 1.1em;
            font-weight: bold;
            padding: 5px;
            border: 1px solid #aaa;
            border-radius: 4px;
            width: 200px;
            color: #d35400;
        }

        .input-row { display: flex; gap: 15px; }
        .input-col { flex: 1; }
        
        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9em; }
        
        textarea {
            width: 100%;
            height: 180px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
        }

        button {
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 5px;
            border: none;
            font-size: 15px;
            font-weight: bold;
            transition: 0.2s;
            white-space: nowrap;
        }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-primary:hover { background-color: #1f6391; }
        
        .btn-success { background-color: var(--success); color: white; width: 100%; padding: 12px; font-size: 16px; }
        .btn-success:hover { background-color: #219150; }

        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { background-color: #c0392b; }

        .btn-add { background-color: var(--warning); color: #fff; }
        .btn-add:hover { background-color: #e67e22; }

        .btn-excel {
            background-color: var(--excel-green); 
            color: white;
            padding: 6px 15px; 
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-excel:hover { background-color: #1a5c38; }

        .btn-excel-all {
            background-color: var(--excel-dark);
            color: white;
            padding: 6px 15px; 
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-excel-all:hover { background-color: #0d2e1c; }

        .delete-block-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: transparent;
            color: #999;
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
        }
        .delete-block-btn:hover {
            background-color: #ffebee;
            color: var(--danger);
            border-color: var(--danger);
        }

        input[type="number"] { padding: 8px; width: 60px; text-align: center; font-size: 16px; }
        select, input[type="text"] { padding: 10px; width: 100%; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th, td { padding: 8px 10px; text-align: center; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; position: sticky; top: 0; z-index: 10; }
        tr:hover { background-color: #f1f1f1; }

        tr.gene-separator { border-top: 2px solid #bdc3c7; }

        .hidden { display: none; }
        .error-msg { color: red; font-size: 0.9em; margin-top: 5px; display: none; }
        .info-box { background: #e8f4fd; color: #0c5460; padding: 10px; border-radius: 5px; font-size: 0.9em; margin-top: 10px; }
        
        /* å…§åƒè­¦å‘Šæ¡†ï¼šé»ƒè‰² */
        .warning-box { background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; border: 1px solid #ffeeba; margin-bottom: 20px; display: none; }
        
        td { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
        
        .checkbox-wrapper { display: flex; align-items: center; margin-top: 5px; font-size: 0.9em; color: #555; gap: 5px; }
        .checkbox-wrapper input { width: auto; margin: 0; }

        /* çµ±è¨ˆå€å¡Šæ¨£å¼ */
        .stat-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }
        @media (max-width: 900px) {
            .stat-grid { grid-template-columns: 1fr; }
        }
        .stat-panel {
            background: #fafbfc;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .anova-result-box {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.95em;
            border-left: 5px solid;
        }
        .anova-pass {
            background-color: #d4edda;
            color: #155724;
            border-color: #28a745;
        }
        /* æ·ºç´…è‰²è­¦å‘Šæ¡† (ANOVAä¸é¡¯è‘—) */
        .anova-fail {
            background-color: #ffebee;
            color: #c0392b; 
            border-color: #ef9a9a;
        }

        .stat-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        .stat-item:last-child { border-bottom: none; }
        .stat-val { font-weight: bold; color: #2c3e50; }
        .stat-sig { color: #e74c3c; font-weight: bold; }
        .stat-bonferroni { color: #8e44ad; font-size: 0.9em; display: block; margin-top: 3px; }
        
        @media (max-width: 600px) {
            .header-row { flex-direction: column; gap: 10px; }
            .header-controls { position: static; transform: none; margin-top: 10px; }
            .export-btn-group { flex-direction: column; width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-row">
        <h1 data-i18n="title">ğŸ§¬ qPCR ç›¸å°å®šé‡åˆ†æå·¥å…· 2^(-Î”Î”Ct)</h1>
        
        <div class="header-controls">
            <a href="https://drive.google.com/file/d/1yDgXBFR4p9nPmxe5KaJ15Y5XY6S_jSX9/view?usp=sharing" class="top-btn" target="_blank" title="Download Offline Version">
                ğŸ“¥ <span data-i18n="btnOffline">ä¸‹è¼‰é›¢ç·šç‰ˆ</span>
            </a>
            <button class="top-btn" onclick="toggleLanguage()">
                ğŸŒ <span id="langText">English</span>
            </button>
        </div>
    </div>

    <div class="card">
        <div class="step-title" data-i18n="step1">1. åˆå§‹è¨­å®š</div>
        <div style="display:flex; align-items:center; gap:15px; flex-wrap: wrap;">
            <label data-i18n="initGeneCount">åˆå§‹åŸºå› æ•¸é‡ï¼š</label>
            <input type="number" id="geneCountInput" value="2" min="2" max="20">
            <button class="btn-primary" onclick="generateGeneBlocks()" data-i18n="startBuild">é–‹å§‹å»ºç«‹å€å¡Š</button>
            <span style="margin-left:auto; font-size:0.9em; color:#666; cursor:pointer; text-decoration:underline;" onclick="loadDemoData()" data-i18n="loadDemo">[è¼‰å…¥ç¯„ä¾‹æ•¸æ“š]</span>
        </div>
        <div style="color: #7f8c8d; font-size: 0.9em; margin-top: 5px;" data-i18n="minGeneNote">
            * è‡³å°‘éœ€è¦ 2 å€‹åŸºå›  (1 å€‹å…§åƒ + 1 å€‹ç›®æ¨™)
        </div>
    </div>

    <div id="dataEntrySection" class="card hidden">
        <div class="step-title">
            <span data-i18n="step2">2. è¼¸å…¥æ•¸æ“š</span>
            <div style="display:flex; gap:10px;">
                <button class="btn-add" onclick="addSingleBlock(false)" data-i18n="addBlock">â• æ–°å¢ä¸€å€‹å€å¡Š</button>
                <button class="btn-danger" onclick="clearAllBlocks()" data-i18n="clearBlocks">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰å€å¡Š</button>
            </div>
        </div>
        
        <p style="font-size:0.9em; color:#666; margin-bottom:15px;" data-i18n="dataInstr">
           è«‹è¼¸å…¥æ¨£æœ¬åç¨±èˆ‡ Ct å€¼ã€‚ç³»çµ±æœƒè‡ªå‹•è¨ˆç®—<span style='color: #e74c3c; font-weight: bold;'>ç›¸åŒæ¨£æœ¬åç¨±</span>çš„å¹³å‡ Ct å€¼ <span style='color: #e74c3c; font-weight: bold;'>(æŠ€è¡“é‡è¤‡)</span>ã€‚<br>è‹¥ç‚º<span style='color: #e74c3c; font-weight: bold;'>ä¸åŒçš„ç¨ç«‹æ¨£æœ¬ (ç”Ÿç‰©é‡è¤‡)</span>ï¼Œè«‹å‹™å¿…ä½¿ç”¨ä¸åŒåç¨±å€åˆ† (å¦‚ WT-1, WT-2)ã€‚
        </p>

        <div id="geneBlocksContainer"></div>
        
        <div style="margin-top: 20px;">
            <button class="btn-success" onclick="processData()" data-i18n="nextStep">ä¸‹ä¸€æ­¥ï¼šè¨­å®šåƒæ•¸</button>
        </div>
        <div id="globalError" style="color:red; text-align:center; margin-top:10px;"></div>
    </div>

    <div id="settingsSection" class="card hidden">
        <div class="step-title" data-i18n="step3">3. åƒæ•¸è¨­å®š</div>
        
        <div style="display:flex; gap:30px; flex-wrap:wrap;">
            <div style="flex:1; min-width:300px;">
                <label data-i18n="refGeneLabel">é¸æ“‡å…§åƒåŸºå›  (Reference Gene)</label>
                <select id="refGeneSelect"></select>
                <div class="info-box">
                    <span data-i18n="deltaCtFormula">ç”¨æ–¼è¨ˆç®— $\Delta Ct = Ct_{Target} - Ct_{Ref}$</span>
                </div>
            </div>

            <div style="flex:1; min-width:300px;">
                <label data-i18n="controlKeyLabel">å°ç…§çµ„é—œéµå­— (Control Keyword)</label>
                <input type="text" id="controlKeyword" value="WT" placeholder="ä¾‹å¦‚: WT">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="exactMatchCheckbox">
                    <label for="exactMatchCheckbox" style="margin-bottom:0; font-weight:normal; cursor:pointer;" data-i18n="exactMatch">å®Œå…¨ç¬¦åˆ (Exact Match) - ç”¨æ–¼ç²¾ç¢ºç¾¤çµ„æ¯”å° (å¦‚ "WT" vs "WT-1")</label>
                </div>
                <div class="info-box" style="margin-top: 5px;" data-i18n="calibratorNote">
                    ç³»çµ±æœƒæ‰¾å‡ºç¬¦åˆæ­¤é—œéµå­—çš„æ¨£æœ¬ï¼Œ<br>
                    ç®—å‡º <b>å¹³å‡ $\Delta Ct$</b> ä½œç‚ºæ ¡æ­£åŸºæº– (Calibrator)ã€‚
                </div>
            </div>
        </div>

        <button class="btn-primary" style="margin-top:20px; width:100%" onclick="calculateResults()" data-i18n="startCalc">é–‹å§‹è¨ˆç®—</button>
    </div>

    <div id="resultSection" class="card hidden">
        <div class="step-title">
            <span data-i18n="step4">4. åˆ†æçµæœ</span>
            <button class="btn-excel" onclick="exportCSV()" data-i18n="exportCSV">ğŸ“Š åŒ¯å‡º CSV (Excel)</button>
        </div>
        
        <div id="warningBox" class="warning-box"></div>
        
        <div style="margin-bottom:10px; font-weight:bold; color:#2980b9;" id="calibratorInfo"></div>

        <div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
            <table id="resultTable">
                <thead>
                    <tr>
                        <th style="width:10%" data-i18n="colGene">åŸºå› </th>
                        <th style="width:15%" data-i18n="colSample">æ¨£æœ¬</th>
                        <th>Mean Ct</th>
                        <th>Î”Ct</th>
                        <th>Î”Î”Ct</th>
                        <th>Fold Change</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="statsSection" class="card hidden">
        <div class="step-title">
            <span data-i18n="step5">5. çµ±è¨ˆåˆ†æèˆ‡ä½œåœ– (Statistics & Plots)</span>
            <div class="export-btn-group" style="display:flex; gap:10px;">
                <button class="btn-excel" onclick="exportStatsCSV()">ğŸ“Š <span data-i18n="btnExportStats">åŒ¯å‡ºç•¶å‰åŸºå› çµ±è¨ˆ</span></button>
                <button class="btn-excel-all" onclick="exportAllStatsCSV()">ğŸ“‘ <span data-i18n="btnExportAllStats">åŒ¯å‡ºå…¨éƒ¨åŸºå› çµ±è¨ˆ</span></button>
            </div>
        </div>
        
        <div class="info-box" style="margin-bottom:20px;">
            <strong data-i18n="statNoteTitle">ğŸ’¡ çµ±è¨ˆç§‘å­¸ä¿®æ­£èªªæ˜ï¼š</strong>
            <span data-i18n="statNoteBody">
                ç‚ºäº†ç¬¦åˆå¸¸æ…‹åˆ†ä½ˆå‡è¨­ï¼Œ<b>P å€¼è¨ˆç®—æ¡ç”¨ Î”Ct å€¼</b>ï¼ˆè€Œé 2^-Î”Î”Ctï¼‰ã€‚<br>
                3 çµ„ä»¥ä¸ŠåŸ·è¡Œ <b>One-way ANOVA</b>ã€‚è‹¥ç‚º 2 çµ„å‰‡é€²è¡Œ <b>Welch's t-test</b> (ä¸å‡è¨­è®Šç•°æ•¸ç›¸ç­‰)ã€‚
            </span>
        </div>

        <div class="stat-grid">
            <div class="stat-panel">
                <h4 style="margin-top:0; border-bottom:1px solid #ddd; padding-bottom:10px;" data-i18n="statPanelTitle">çµ±è¨ˆæª¢å®šçµæœ (åŸºæ–¼ Î”Ct)</h4>
                <div id="statResultsContainer"></div>
            </div>

            <div>
                 <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <label data-i18n="plotGeneLabel">é¸æ“‡ç¹ªåœ–åŸºå› ï¼š</label>
                    <select id="plotGeneSelect" onchange="updatePlot()" style="width:auto; padding:5px;"></select>
                 </div>
                 <div id="plotlyChart" style="width:100%; height:500px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- å¤šèªè¨€è¨­å®š ---
    let currentLang = 'zh'; 
    
    const translations = {
        'zh': {
            title: "ğŸ§¬ qPCR ç›¸å°å®šé‡åˆ†æå·¥å…· 2^(-Î”Î”Ct)",
            langBtn: "English",
            btnOffline: "ä¸‹è¼‰é›¢ç·šç‰ˆ",
            step1: "1. åˆå§‹è¨­å®š",
            initGeneCount: "åˆå§‹åŸºå› æ•¸é‡ï¼š",
            startBuild: "é–‹å§‹å»ºç«‹å€å¡Š",
            loadDemo: "[è¼‰å…¥ç¯„ä¾‹æ•¸æ“š]",
            minGeneNote: "* è‡³å°‘éœ€è¦ 2 å€‹åŸºå›  (1 å€‹å…§åƒ + 1 å€‹ç›®æ¨™)",
            step2: "2. è¼¸å…¥æ•¸æ“š",
            addBlock: "â• æ–°å¢ä¸€å€‹å€å¡Š",
            clearBlocks: "ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰å€å¡Š",
            dataInstr: "è«‹è¼¸å…¥æ¨£æœ¬åç¨±èˆ‡ Ct å€¼ã€‚ç³»çµ±æœƒè‡ªå‹•è¨ˆç®—<span style='color: #e74c3c; font-weight: bold;'>ç›¸åŒæ¨£æœ¬åç¨±</span>çš„å¹³å‡ Ct å€¼ <span style='color: #e74c3c; font-weight: bold;'>(æŠ€è¡“é‡è¤‡)</span>ã€‚<br>è‹¥ç‚º<span style='color: #e74c3c; font-weight: bold;'>ä¸åŒçš„ç¨ç«‹æ¨£æœ¬ (ç”Ÿç‰©é‡è¤‡)</span>ï¼Œè«‹å‹™å¿…ä½¿ç”¨ä¸åŒåç¨±å€åˆ† (å¦‚ WT-1, WT-2)ã€‚",
            nextStep: "ä¸‹ä¸€æ­¥ï¼šè¨­å®šåƒæ•¸",
            geneNameLabel: "åŸºå› åç¨±ï¼š",
            sampleLabel: "â¬‡ï¸ æ¨£æœ¬åç¨± (Sample)",
            ctLabel: "â¬‡ï¸ Ct å€¼ (è¼¸å…¥åŸå§‹æ•¸å€¼ï¼Œç³»çµ±è‡ªå‹•å–å¹³å‡)",
            errorRowMsg: "âš ï¸ è¡Œæ•¸ä¸ç¬¦ï¼Œè«‹æª¢æŸ¥ã€‚",
            step3: "3. åƒæ•¸è¨­å®š",
            refGeneLabel: "é¸æ“‡å…§åƒåŸºå›  (Reference Gene)",
            deltaCtFormula: "ç”¨æ–¼è¨ˆç®— $\\Delta Ct = Ct_{Target} - Ct_{Ref}$",
            controlKeyLabel: "å°ç…§çµ„é—œéµå­— (Control Keyword)",
            exactMatch: "å®Œå…¨ç¬¦åˆ (Exact Match) - ç”¨æ–¼ç²¾ç¢ºç¾¤çµ„æ¯”å° (å¦‚ \"WT\" vs \"WT-1\")",
            calibratorNote: "ç³»çµ±æœƒæ‰¾å‡ºç¬¦åˆæ­¤é—œéµå­—çš„æ¨£æœ¬ï¼Œ<br>ç®—å‡º <b>å¹³å‡ $\\Delta Ct$</b> ä½œç‚ºæ ¡æ­£åŸºæº– (Calibrator)ã€‚",
            startCalc: "é–‹å§‹è¨ˆç®—",
            step4: "4. åˆ†æçµæœ",
            exportCSV: "ğŸ“Š åŒ¯å‡º CSV (Excel)",
            colGene: "åŸºå› ",
            colSample: "æ¨£æœ¬",
            step5: "5. çµ±è¨ˆåˆ†æèˆ‡ä½œåœ– (Statistics & Plots)",
            btnExportStats: "åŒ¯å‡ºç•¶å‰åŸºå› çµ±è¨ˆ",
            btnExportAllStats: "åŒ¯å‡ºå…¨éƒ¨åŸºå› çµ±è¨ˆ",
            statNoteTitle: "ğŸ’¡ çµ±è¨ˆç§‘å­¸ä¿®æ­£èªªæ˜ï¼š",
            statNoteBody: "ç‚ºäº†ç¬¦åˆå¸¸æ…‹åˆ†ä½ˆå‡è¨­ï¼Œ<b>P å€¼è¨ˆç®—æ¡ç”¨ Î”Ct å€¼</b>ï¼ˆè€Œé 2^-Î”Î”Ctï¼‰ã€‚<br>3 çµ„ä»¥ä¸ŠåŸ·è¡Œ <b>One-way ANOVA</b>ã€‚è‹¥ç‚º 2 çµ„å‰‡é€²è¡Œ <b>Welch's t-test</b> (ä¸å‡è¨­è®Šç•°æ•¸ç›¸ç­‰)ã€‚",
            bonferroniWarn: "âš ï¸ æª¢æ¸¬åˆ°å¤šçµ„æ¯”è¼ƒ ({n} çµ„)ã€‚<br>P å€¼å·²è‡ªå‹•æ‡‰ç”¨ <b>Bonferroni æ ¡æ­£</b> (P_adj = P * {n})ã€‚",
            statPanelTitle: "çµ±è¨ˆæª¢å®šçµæœ (åŸºæ–¼ Î”Ct)",
            plotGeneLabel: "é¸æ“‡ç¹ªåœ–åŸºå› ï¼š",
            pVal: "På€¼ (åŸå§‹)",
            pValAdj: "På€¼ (æ ¡æ­£)",
            statSig: "é¡¯è‘—",
            statNs: "ä¸é¡¯è‘—",
            alertMinGene: "éŒ¯èª¤ï¼šåˆå§‹è‡³å°‘éœ€è¦ 2 å€‹åŸºå› ã€‚",
            alertConfirmClear: "ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å·²ç”Ÿæˆçš„å€å¡Šå—ï¼Ÿ\næ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼",
            alertBlockCount: "éŒ¯èª¤ï¼šç›®å‰åªæœ‰ {n} å€‹å€å¡Šã€‚\nåˆ†æè‡³å°‘éœ€è¦ 2 å€‹åŸºå›  (1å€‹å…§åƒ + 1å€‹ç›®æ¨™)ã€‚",
            alertRowMismatch: "éƒ¨åˆ†å€å¡Šçš„æ¨£æœ¬èˆ‡ Ct å€¼è¡Œæ•¸ä¸ä¸€è‡´ï¼Œè«‹æª¢æŸ¥ç´…è‰²éŒ¯èª¤ã€‚",
            alertValidGene: "æœ‰æ•ˆæ•¸æ“šçš„åŸºå› æ•¸é‡ä¸è¶³ 2 å€‹ï¼Œè«‹æª¢æŸ¥æ˜¯å¦æœ‰ç©ºç™½å€å¡Šã€‚",
            alertNoKeyword: "è«‹è¼¸å…¥å°ç…§çµ„é—œéµå­— (ä¾‹å¦‚ WT)ã€‚",
            alertNoCalibrator: "æ‰¾ä¸åˆ° {mode} \"{keyword}\" ä¸”è³‡æ–™å®Œæ•´çš„æ¨£æœ¬ï¼Œç„¡æ³•è¨ˆç®—åŸºæº–å€¼ã€‚",
            modeExact: "ç¾¤çµ„åç¨±ç‚º",
            modeContains: "åŒ…å«é—œéµå­—",
            warnMissingRef: "âš ï¸ <b>è­¦å‘Šï¼š</b>ä»¥ä¸‹æ¨£æœ¬å› ç¼ºå°‘å…§åƒåŸºå›  ({ref}) çš„æ•¸æ“šï¼Œå·²è¢«æ’é™¤åœ¨è¨ˆç®—ä¹‹å¤–ï¼š<br>{samples}",
            calibInfo: "â„¹ï¸ å·²ä½¿ç”¨ {n} å€‹ \"{keyword}\" {mode} æ¨£æœ¬çš„å¹³å‡ Î”Ct ä½œç‚ºåŸºæº–",
            demoLoaded: "å·²è¼‰å…¥ç¯„ä¾‹ï¼",
            placeholderKeyword: "ä¾‹å¦‚: WT",
            alertNoControlGroup: "éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç¬¦åˆã€Œå°ç…§çµ„é—œéµå­—ã€çš„åˆ†çµ„ã€‚è«‹æª¢æŸ¥é—œéµå­—æ˜¯å¦èˆ‡æ¨£æœ¬åç¨±ä¸€è‡´ã€‚",
            alertNoStats: "ç„¡çµ±è¨ˆæ•¸æ“šå¯åŒ¯å‡º",
            alertAllStatsNoRef: "è·³é {gene} (ç‚ºå…§åƒåŸºå› )",
            alertAllStatsError: "åŸºå›  {gene} ç„¡æ³•è¨ˆç®—: {msg}",
            anovaTitle: "å–®å› å­è®Šç•°æ•¸åˆ†æ (One-way ANOVA)",
            anovaSigMsg: "âœ… P = {p} < 0.05 (çµ„é–“æœ‰é¡¯è‘—å·®ç•°)",
            anovaNsMsg: "âš ï¸ P = {p} > 0.05 (çµ„é–“ç„¡é¡¯è‘—å·®ç•°)",
            anovaNsHint: "ç”±æ–¼ ANOVA ä¸é¡¯è‘—ï¼Œçµ±è¨ˆä¸Šä¸å»ºè­°é€²è¡Œå€‹åˆ¥çµ„é–“æ¯”è¼ƒ (Post-hoc test)ï¼Œè«‹è¬¹æ…è§£è®€ä»¥ä¸‹çµæœã€‚"
        },
        'en': {
            title: "ğŸ§¬ qPCR Analysis Tool 2^(-Î”Î”Ct)",
            langBtn: "ä¸­æ–‡",
            btnOffline: "Download Offline",
            step1: "1. Initial Setup",
            initGeneCount: "Initial Gene Count:",
            startBuild: "Generate Blocks",
            loadDemo: "[Load Demo Data]",
            minGeneNote: "* At least 2 genes required (1 Ref + 1 Target)",
            step2: "2. Data Entry",
            addBlock: "â• Add Block",
            clearBlocks: "ğŸ—‘ï¸ Clear All",
            dataInstr: "Enter Sample Names and Ct Values. Same names = Technical Replicates. Biological Replicates must have unique names (e.g., WT-1, WT-2).",
            nextStep: "Next: Parameters",
            geneNameLabel: "Gene Name:",
            sampleLabel: "â¬‡ï¸ Sample Names",
            ctLabel: "â¬‡ï¸ Ct Values",
            errorRowMsg: "âš ï¸ Row count mismatch.",
            step3: "3. Parameters",
            refGeneLabel: "Select Reference Gene",
            deltaCtFormula: "Calculates Î”Ct = Ct_Target - Ct_Ref",
            controlKeyLabel: "Control Group Keyword",
            exactMatch: "Exact Match (matches Group Name)",
            calibratorNote: "Finds samples matching this keyword, calculates Mean Î”Ct as Calibrator.",
            startCalc: "Calculate Results",
            step4: "4. Results",
            exportCSV: "ğŸ“Š Export CSV (Excel)",
            colGene: "Gene",
            colSample: "Sample",
            step5: "5. Statistics & Plots",
            btnExportStats: "Export Current Gene Stats",
            btnExportAllStats: "Export All Genes Stats",
            statNoteTitle: "ğŸ’¡ Statistics Note:",
            statNoteBody: "<b>P-values are calculated using Î”Ct</b> (not 2^-Î”Î”Ct) to meet normality assumptions. <br><b>One-way ANOVA</b> is used for 3+ groups. Pairwise comparisons use <b>Welch's t-test</b> (unequal variance).",
            bonferroniWarn: "âš ï¸ Multiple comparisons detected ({n} groups).<br>P-values adjusted via <b>Bonferroni correction</b> (P_adj = P * {n}).",
            statPanelTitle: "Statistical Test (Based on Î”Ct)",
            plotGeneLabel: "Select Gene for Plot:",
            pVal: "P-value (Raw)",
            pValAdj: "P-value (Adj)",
            statSig: "Significant",
            statNs: "Not Significant",
            alertMinGene: "Error: At least 2 genes required.",
            alertConfirmClear: "Are you sure you want to clear all?",
            alertBlockCount: "Error: Only {n} blocks found.",
            alertRowMismatch: "Row count mismatch.",
            alertValidGene: "Less than 2 valid genes.",
            alertNoKeyword: "Please enter Control Keyword.",
            alertNoCalibrator: "No valid control samples found.",
            // ä¿®æ­£ï¼šè£œä¸Šç¼ºå¤±å…§åƒè­¦å‘Šçš„è‹±æ–‡ç¿»è­¯ç´°ç¯€
            warnMissingRef: "âš ï¸ <b>Warning:</b> The following samples are excluded due to missing Reference Gene ({ref}) data:<br>{samples}",
            calibInfo: "â„¹ï¸ Used {n} \"{keyword}\" samples as Calibrator",
            demoLoaded: "Demo Loaded!",
            placeholderKeyword: "e.g., WT",
            alertNoControlGroup: "Error: No group matches the Control Keyword. Please check if the keyword matches sample names.",
            alertNoStats: "No stats data available",
            alertAllStatsNoRef: "Skipping {gene} (Ref Gene)",
            alertAllStatsError: "Gene {gene} error: {msg}",
            anovaTitle: "One-way ANOVA",
            anovaSigMsg: "âœ… P = {p} < 0.05 (Significant Difference)",
            anovaNsMsg: "âš ï¸ P = {p} > 0.05 (No Significant Difference)",
            anovaNsHint: "Since ANOVA is not significant, pairwise comparisons are not recommended. Please interpret results below with caution."
        }
    };

    function toggleLanguage() {
        currentLang = currentLang === 'zh' ? 'en' : 'zh';
        updateTexts();
    }

    function t(key) {
        return translations[currentLang][key] || key;
    }

    function updateTexts() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if(translations[currentLang][key]) {
                el.innerHTML = translations[currentLang][key]; 
            }
        });
        document.getElementById('langText').innerText = translations[currentLang]['langBtn'];
        const keyInput = document.getElementById('controlKeyword');
        if(keyInput) keyInput.placeholder = t('placeholderKeyword');
        
        if(!document.getElementById('statsSection').classList.contains('hidden')) {
             updatePlot();
        }
        
        // æ›´æ–° Calibrator Info
        const infoEl = document.getElementById('calibratorInfo');
        if (infoEl) {
            const savedN = infoEl.getAttribute('data-n');
            const savedKw = infoEl.getAttribute('data-kw');
            if (savedN && savedKw) {
                const matchModeText = document.getElementById('exactMatchCheckbox').checked ? 
                    t('modeExact') : t('modeContains');
                infoEl.innerText = t('calibInfo')
                    .replace('{n}', savedN)
                    .replace('{keyword}', savedKw)
                    .replace('{mode}', matchModeText);
            }
        }

        // æ–°å¢ï¼šæ›´æ–°ç¼ºå¤±å…§åƒè­¦å‘Šæ¡† (Missing Ref Warning)
        const warningEl = document.getElementById('warningBox');
        if (warningEl && warningEl.style.display !== 'none') {
            const missingSamples = warningEl.getAttribute('data-missing-samples');
            const refGene = warningEl.getAttribute('data-ref-gene');
            
            if (missingSamples && refGene) {
                const msg = t('warnMissingRef')
                    .replace('{ref}', refGene)
                    .replace('{samples}', missingSamples);
                warningEl.innerHTML = msg;
            }
        }
    }

    // --- æ ¸å¿ƒè®Šæ•¸ ---
    let GLOBAL_DATA = {}; 
    let GENE_LIST = [];
    let SAMPLE_LIST = new Set();
    let FOLD_CHANGE_DATA = []; 
    let blockCounter = 0; 
    
    // ç”¨æ–¼å„²å­˜ "ç•¶å‰" é¡¯ç¤ºåŸºå› çš„çµ±è¨ˆçµæœ (ä¾›å–®ä¸€åŒ¯å‡ºä½¿ç”¨)
    let CURRENT_STATS_EXPORT_DATA = []; 
    let CURRENT_ANOVA_RESULT = null; // å„²å­˜ç•¶å‰åŸºå› çš„ ANOVA P

    // --- Utility Function: Get Group Name ---
    function getGroupName(sampleName) {
        return sampleName.replace(/[-_ ]\d+$/, ''); 
    }

    // --- 1. å»ºç«‹ç•Œé¢èˆ‡æ•¸æ“šè¼¸å…¥ ---
    function generateGeneBlocks() {
        const countInput = document.getElementById('geneCountInput');
        let count = parseInt(countInput.value) || 0;
        if (count < 2) { alert(t('alertMinGene')); return; }

        const container = document.getElementById('geneBlocksContainer');
        container.innerHTML = ''; 
        blockCounter = 0;

        for (let i = 0; i < count; i++) { addSingleBlock(true); }
        showStep(2);
    }

    function addSingleBlock(isAuto = false) {
        blockCounter++;
        const container = document.getElementById('geneBlocksContainer');
        const id = `block_${Date.now()}_${blockCounter}`; 
        const currentCount = container.children.length + 1;

        const html = `
            <div class="gene-block" id="${id}">
                <button type="button" class="delete-block-btn" onclick="removeBlock('${id}')" title="Delete">âœ•</button>
                <div class="gene-header">
                    <label data-i18n="geneNameLabel">${t('geneNameLabel')}</label>
                    <input type="text" class="gene-name-input" value="Gene ${currentCount}">
                </div>
                <div class="input-row">
                    <div class="input-col">
                        <label data-i18n="sampleLabel">${t('sampleLabel')}</label>
                        <textarea class="samples-input" placeholder="WT-1\nWT-2\nTreat-1..."></textarea>
                    </div>
                    <div class="input-col">
                        <label data-i18n="ctLabel">${t('ctLabel')}</label>
                        <textarea class="cts-input" placeholder="22.5\n22.8\n24.0..."></textarea>
                    </div>
                </div>
                <div class="error-msg" data-i18n="errorRowMsg" style="display:none;">${t('errorRowMsg')}</div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
        if (!isAuto) {
             setTimeout(() => { document.getElementById(id)?.scrollIntoView({behavior: "smooth", block: "center"}); }, 100);
        }
    }

    function removeBlock(id) { document.getElementById(id)?.remove(); }
    function clearAllBlocks() {
        if(confirm(t('alertConfirmClear'))) {
            document.getElementById('geneBlocksContainer').innerHTML = '';
            blockCounter = 0; 
        }
    }

    function showStep(step) {
        if(step === 2) {
            document.getElementById('dataEntrySection').classList.remove('hidden');
            document.getElementById('settingsSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('statsSection').classList.add('hidden');
            document.getElementById('dataEntrySection').scrollIntoView({behavior: "smooth"});
        }
    }

    function processData() {
        GLOBAL_DATA = {};
        GENE_LIST = [];
        SAMPLE_LIST = new Set();
        let hasError = false;

        const blocks = document.querySelectorAll('.gene-block');
        if (blocks.length < 2) { alert(t('alertBlockCount').replace('{n}', blocks.length)); return; }

        blocks.forEach((block) => {
            const geneName = block.querySelector('.gene-name-input').value.trim();
            const sampleText = block.querySelector('.samples-input').value.trim();
            const ctText = block.querySelector('.cts-input').value.trim();
            const errorMsg = block.querySelector('.error-msg');

            const samples = sampleText.split(/[\n\r]+/).map(s => s.trim()).filter(s => s);
            const cts = ctText.split(/[\n\r]+/).map(c => c.trim()).filter(c => c);

            if (samples.length !== cts.length) {
                errorMsg.style.display = 'block';
                hasError = true;
                return; 
            }
            errorMsg.style.display = 'none';
            if (samples.length === 0) return; 

            if (!GENE_LIST.includes(geneName)) GENE_LIST.push(geneName);

            for(let i=0; i<samples.length; i++) {
                const sName = samples[i];
                const ctVal = parseFloat(cts[i]);
                if (!isNaN(ctVal)) {
                    SAMPLE_LIST.add(sName);
                    if (!GLOBAL_DATA[sName]) GLOBAL_DATA[sName] = {};
                    if (!GLOBAL_DATA[sName][geneName]) GLOBAL_DATA[sName][geneName] = [];
                    GLOBAL_DATA[sName][geneName].push(ctVal);
                }
            }
        });

        if (hasError) { alert(t('alertRowMismatch')); return; }
        if (GENE_LIST.length < 2) { alert(t('alertValidGene')); return; }

        populateSettings();
        document.getElementById('settingsSection').classList.remove('hidden');
        document.getElementById('settingsSection').scrollIntoView({behavior: "smooth"});
    }

    function populateSettings() {
        const refSelect = document.getElementById('refGeneSelect');
        refSelect.innerHTML = '';
        GENE_LIST.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g; opt.innerText = g;
            if (['GAPDH', 'ACTB', '18S'].includes(g.toUpperCase())) opt.selected = true;
            refSelect.appendChild(opt);
        });
    }

    // --- 2. è¨ˆç®—é‚è¼¯ ---
    function calculateResults() {
        const refGene = document.getElementById('refGeneSelect').value;
        const ctrlKeyword = document.getElementById('controlKeyword').value.trim();
        const useExactMatch = document.getElementById('exactMatchCheckbox').checked; 

        if (!ctrlKeyword) { alert(t('alertNoKeyword')); return; }

        const tbody = document.querySelector('#resultTable tbody');
        tbody.innerHTML = '';
        FOLD_CHANGE_DATA = []; 
        
        // A. Delta Ct
        let sampleStats = {}; 
        let missingRefSamples = []; // ç”¨æ–¼æ”¶é›†ç¼ºå°‘å…§åƒçš„æ¨£æœ¬
        
        SAMPLE_LIST.forEach(sName => {
            // æª¢æŸ¥è©²æ¨£æœ¬æ˜¯å¦æœ‰å…§åƒåŸºå› æ•¸æ“š
            if (!GLOBAL_DATA[sName][refGene] || GLOBAL_DATA[sName][refGene].length === 0) { 
                missingRefSamples.push(sName);
                return; 
            }
            
            sampleStats[sName] = {};
            const refMean = getMean(GLOBAL_DATA[sName][refGene]);
            GENE_LIST.forEach(gName => {
                if (GLOBAL_DATA[sName][gName]) {
                    const targetMean = getMean(GLOBAL_DATA[sName][gName]);
                    sampleStats[sName][gName] = { meanCt: targetMean, deltaCt: targetMean - refMean };
                }
            });
        });

        // é¡¯ç¤ºæˆ–éš±è—è­¦å‘Šæ¡†
        const warningEl = document.getElementById('warningBox');
        if (missingRefSamples.length > 0) {
            // å„²å­˜æ•¸æ“šä»¥ä¾›åˆ‡æ›èªè¨€ä½¿ç”¨
            warningEl.setAttribute('data-missing-samples', missingRefSamples.join(', '));
            warningEl.setAttribute('data-ref-gene', refGene);

            const msg = t('warnMissingRef')
                .replace('{ref}', refGene)
                .replace('{samples}', missingRefSamples.join(', '));
            warningEl.innerHTML = msg;
            warningEl.style.display = 'block';
        } else {
            warningEl.style.display = 'none';
            // æ¸…é™¤æš«å­˜æ•¸æ“š
            warningEl.removeAttribute('data-missing-samples');
            warningEl.removeAttribute('data-ref-gene');
        }

        // B. Calibrator
        let calibrators = {}; 
        let controlCount = 0; 
        
        SAMPLE_LIST.forEach(sName => {
            const groupName = getGroupName(sName);
            const isMatch = useExactMatch ? (groupName === ctrlKeyword) : sName.includes(ctrlKeyword);
            
            if (isMatch && sampleStats[sName] && sampleStats[sName][refGene]) { controlCount++; }
        });

        GENE_LIST.forEach(gName => {
            let sumDelta = 0, count = 0;
            SAMPLE_LIST.forEach(sName => {
                const groupName = getGroupName(sName);
                const isMatch = useExactMatch ? (groupName === ctrlKeyword) : sName.includes(ctrlKeyword);
                
                if (isMatch && sampleStats[sName] && sampleStats[sName][gName]) {
                    sumDelta += sampleStats[sName][gName].deltaCt;
                    count++;
                }
            });
            if (count > 0) calibrators[gName] = sumDelta / count;
        });

        if (Object.keys(calibrators).length === 0) {
            const matchMsg = useExactMatch ? t('modeExact') : t('modeContains');
            alert(t('alertNoCalibrator').replace('{mode}', matchMsg).replace('{keyword}', ctrlKeyword));
            return;
        }

        // C. Render Table
        const sortedSamples = Array.from(SAMPLE_LIST).sort((a, b) => 
            a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
        );
        
        let lastGene = "";
        GENE_LIST.forEach(gName => {
            const calibDelta = calibrators[gName];
            sortedSamples.forEach(sName => {
                if (!sampleStats[sName] || !sampleStats[sName][gName]) return;

                const stats = sampleStats[sName][gName];
                let ddCt = null;
                let foldChange = null;

                if (calibDelta !== undefined) {
                    ddCt = stats.deltaCt - calibDelta;
                    foldChange = Math.pow(2, -ddCt);
                    
                    if (gName !== refGene) {
                        FOLD_CHANGE_DATA.push({
                            gene: gName,
                            sample: sName,
                            foldChange: foldChange,
                            deltaCt: stats.deltaCt 
                        });
                    }
                }

                const tr = document.createElement('tr');
                if (gName !== lastGene && lastGene !== "") tr.classList.add('gene-separator');
                lastGene = gName;

                tr.innerHTML = `
                    <td style="font-weight:bold;">${gName}</td>
                    <td>${sName}</td>
                    <td>${stats.meanCt.toFixed(4)}</td>
                    <td style="color:#666">${stats.deltaCt.toFixed(4)}</td>
                    <td>${ddCt !== null ? ddCt.toFixed(4) : '-'}</td>
                    <td style="font-weight:bold; color:${foldChange > 1.5 ? '#c0392b' : '#2c3e50'}">
                        ${foldChange !== null ? foldChange.toFixed(4) : '-'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        });

        const infoEl = document.getElementById('calibratorInfo');
        infoEl.setAttribute('data-n', controlCount);
        infoEl.setAttribute('data-kw', ctrlKeyword);
        
        const matchModeText = useExactMatch ? t('modeExact') : t('modeContains');
        infoEl.innerText = t('calibInfo')
            .replace('{n}', controlCount)
            .replace('{keyword}', ctrlKeyword)
            .replace('{mode}', matchModeText);
        
        document.getElementById('resultSection').classList.remove('hidden');
        document.getElementById('statsSection').classList.remove('hidden');
        
        initStatsSection();
        document.getElementById('resultSection').scrollIntoView({behavior: "smooth"});
    }

    // --- 3. çµ±è¨ˆèˆ‡ç¹ªåœ– (æ ¸å¿ƒé‚è¼¯: ANOVA + T-test) ---

    function initStatsSection() {
        const select = document.getElementById('plotGeneSelect');
        const refGene = document.getElementById('refGeneSelect').value;
        select.innerHTML = '';
        
        GENE_LIST.forEach(g => {
            if (g !== refGene) {
                const opt = document.createElement('option');
                opt.value = g;
                opt.innerText = g;
                select.appendChild(opt);
            }
        });
        
        updatePlot();
    }

    /**
     * æ ¸å¿ƒè¨ˆç®—å‡½æ•¸ï¼šé‡å°å–®ä¸€åŸºå› é€²è¡Œçµ±è¨ˆåˆ†æ (ANOVA + Pairwise)
     * @param {string} targetGene åŸºå› åç¨±
     * @returns {object} { results: Array, groupsFC: Object, groupNames: Array, error: string, anovaP: number }
     */
    function calculateGeneStats(targetGene) {
        const ctrlKeyword = document.getElementById('controlKeyword').value.trim();
        const useExactMatch = document.getElementById('exactMatchCheckbox').checked;

        // 1. æ•´ç†æ•¸æ“š
        let groupsFC = {};     
        let groupsDeltaCt = {}; 
        
        FOLD_CHANGE_DATA.forEach(d => {
            if (d.gene === targetGene) {
                const grpName = getGroupName(d.sample);
                
                if (!groupsFC[grpName]) groupsFC[grpName] = [];
                groupsFC[grpName].push(d.foldChange);

                if (!groupsDeltaCt[grpName]) groupsDeltaCt[grpName] = [];
                groupsDeltaCt[grpName].push(d.deltaCt);
            }
        });

        // 2. æ’åºèˆ‡å°‹æ‰¾ Control
        let groupNames = Object.keys(groupsFC).sort((a, b) => 
            a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
        );

        const controlGroupMatch = groupNames.find(g => 
            useExactMatch ? g === ctrlKeyword : g.includes(ctrlKeyword)
        );
        
        if (!controlGroupMatch) {
            return { error: `âŒ ${t('alertNoControlGroup')}` };
        }

        const controlGroup = controlGroupMatch;
        groupNames = [controlGroup, ...groupNames.filter(g => g !== controlGroup)];

        // --- ANOVA Calculation ---
        // æ”¶é›†æ‰€æœ‰æœ‰æ•ˆçµ„åˆ¥çš„ Delta Ct é™£åˆ— (ç”¨æ–¼ ANOVA)
        let anovaDataArrays = [];
        groupNames.forEach(g => {
            if(groupsDeltaCt[g] && groupsDeltaCt[g].length >= 2) {
                anovaDataArrays.push(groupsDeltaCt[g]);
            }
        });

        // *** ä¿®æ­£é‡é»ï¼šåªæœ‰ç•¶çµ„åˆ¥æ•¸ > 2 æ™‚æ‰é€²è¡Œ ANOVA ***
        let anovaP = null;
        if (anovaDataArrays.length > 2) {
            // jStat.anovaftest(array1, array2, ...)
            anovaP = jStat.anovaftest(...anovaDataArrays);
        }

        // --- Pairwise Comparisons ---
        const comparisonCount = groupNames.length - 1; 
        const ctrlDeltaCtData = groupsDeltaCt[controlGroup];
        let results = [];

        groupNames.forEach(grp => {
            if (grp === controlGroup) return;
            
            const fcData = groupsFC[grp];
            const meanFC = getMean(fcData);
            const semFC = calculateStandardError(fcData);
            const ctrlFCMean = getMean(groupsFC[controlGroup]);
            const ctrlFCSem = calculateStandardError(groupsFC[controlGroup]);
            const expDeltaCt = groupsDeltaCt[grp];
            
            let statObj = {
                comparison: `${grp} vs ${controlGroup}`,
                grp: grp,
                ctrl: controlGroup,
                nExp: expDeltaCt ? expDeltaCt.length : 0,
                nCtrl: ctrlDeltaCtData ? ctrlDeltaCtData.length : 0,
                meanFC: meanFC,
                ctrlMeanFC: ctrlFCMean,
                semFC: semFC,
                ctrlSemFC: ctrlFCSem,
                pRaw: 1.0,
                pAdj: 1.0,
                sig: 'ns'
            };

            if (ctrlDeltaCtData && ctrlDeltaCtData.length > 1 && expDeltaCt && expDeltaCt.length > 1) {
                let pValue = twoSampleTtest(expDeltaCt, ctrlDeltaCtData);
                let adjPValue = pValue * comparisonCount;
                if (adjPValue > 1.0) adjPValue = 1.0;
                
                statObj.pRaw = pValue;
                statObj.pAdj = adjPValue;
                statObj.sig = getStars(adjPValue);
            } else {
                statObj.error = "N<2";
            }
            results.push(statObj);
        });

        return { 
            results: results, 
            groupsFC: groupsFC, 
            groupNames: groupNames, 
            comparisonCount: comparisonCount,
            controlGroup: controlGroup,
            anovaP: anovaP // å›å‚³ ANOVA P å€¼ (å¦‚æœçµ„åˆ¥<=2ï¼Œæ­¤å€¼ç‚º null)
        };
    }

    function updatePlot() {
        const targetGene = document.getElementById('plotGeneSelect').value;
        if (!targetGene) return;

        // å‘¼å«æ ¸å¿ƒè¨ˆç®—å‡½æ•¸
        const analysis = calculateGeneStats(targetGene);
        
        if (analysis.error) {
            document.getElementById('statResultsContainer').innerHTML = "";
            document.getElementById('plotlyChart').innerHTML = `
                <div style="display:flex;justify-content:center;align-items:center;height:100%;color:#e74c3c;font-size:1.1em;border:2px dashed #e74c3c;border-radius:10px;">
                    ${analysis.error}
                </div>`;
            CURRENT_STATS_EXPORT_DATA = [];
            CURRENT_ANOVA_RESULT = null;
            return;
        }

        const { results, groupsFC, groupNames, comparisonCount, controlGroup, anovaP } = analysis;
        
        // å„²å­˜ç•¶å‰æ•¸æ“šä¾›åŒ¯å‡º
        CURRENT_STATS_EXPORT_DATA = results.map(r => ({ ...r, targetGene: targetGene, anovaP: anovaP }));
        CURRENT_ANOVA_RESULT = anovaP;

        let finalHTML = "";

        // --- 1. é¡¯ç¤º ANOVA çµæœ (åƒ…ç•¶çµ„æ•¸ > 2 æ™‚) ---
        if (anovaP !== null) {
            const isAnovaSig = anovaP < 0.05;
            const pText = anovaP.toFixed(6);
            const msg = isAnovaSig ? t('anovaSigMsg').replace('{p}', pText) : t('anovaNsMsg').replace('{p}', pText);
            const cssClass = isAnovaSig ? 'anova-pass' : 'anova-fail';
            
            finalHTML += `
                <div class="anova-result-box ${cssClass}">
                    <strong>${t('anovaTitle')}</strong><br>
                    <span style="font-size:1.1em">${msg}</span>
                    ${!isAnovaSig ? `<br><div style='margin-top:5px; font-size:0.9em; opacity:0.85;'>${t('anovaNsHint')}</div>` : ''}
                </div>
            `;
        }
        
        // --- 2. é¡¯ç¤ºæˆå°æ¯”è¼ƒåˆ—è¡¨ (ç¸½æ˜¯é¡¯ç¤º) ---
        if (comparisonCount > 1) {
            const warnText = t('bonferroniWarn').replace(/\{n\}/g, comparisonCount);
            finalHTML += `
            <div style="background:#fff8e1; color:#856404; padding:8px; border-radius:4px; font-size:0.9em; margin-bottom:15px; border:1px solid #ffeeba;">
                ${warnText}
            </div>`;
        }
        
        results.forEach(stat => {
            if (stat.error) {
                finalHTML += `<div class="stat-item">${stat.grp}: N<2, ç„¡æ³•æª¢å®š</div>`;
            } else {
                const isSig = stat.pAdj < 0.05;
                finalHTML += `
                    <div class="stat-item">
                        <div><b>${stat.comparison}</b> <span style="font-size:0.8em; color:#666;">(n=${stat.nExp} vs n=${stat.nCtrl})</span></div>
                        <div>Mean FC: ${stat.meanFC.toFixed(2)} vs ${stat.ctrlMeanFC.toFixed(2)}</div>
                        <div>${t('pVal')}: ${stat.pRaw.toFixed(8)}</div>
                        <div class="stat-bonferroni">
                            ${t('pValAdj')}: <span class="${isSig ? 'stat-sig' : ''}">${stat.pAdj.toFixed(8)} ${stat.sig}</span>
                        </div>
                    </div>
                `;
            }
        });

        document.getElementById('statResultsContainer').innerHTML = finalHTML || "ç„¡æ•¸æ“š";

        // --- 3. ç¹ªåœ– (æ°¸é é¡¯ç¤ºåœ–è¡¨ï¼Œæ–¹ä¾¿ä½¿ç”¨è€…æª¢æŸ¥æ•¸æ“šåˆ†å¸ƒ) ---
        let annotations = [];
        
        // æ˜Ÿè™Ÿé¡¯ç¤ºé‚è¼¯ï¼š
        // 1. å¦‚æœæœ‰è·‘ ANOVA (çµ„æ•¸>2) ä¸” ANOVA é¡¯è‘— -> æ¨™ç¤ºæ˜Ÿè™Ÿ
        // 2. å¦‚æœæ²’è·‘ ANOVA (çµ„æ•¸=2) -> ç›´æ¥æ¨™ç¤º T-test æ˜Ÿè™Ÿ
        const showStars = (anovaP === null) || (anovaP < 0.05);

        if (showStars) {
            results.forEach(stat => {
                if (!stat.error) {
                    const yPos = Math.max(0, stat.meanFC) + stat.semFC + (Math.max(0.1, stat.meanFC) * 0.15);
                    annotations.push({
                        x: stat.grp,
                        y: yPos,
                        text: stat.sig,
                        xanchor: 'center',
                        yanchor: 'bottom',
                        showarrow: false,
                        font: { size: 16, color: stat.sig !== 'ns' ? '#e74c3c' : '#7f8c8d' }
                    });
                }
            });
        }

        const xData = [];
        const yMean = [];
        const yError = [];
        const tracePointsX = [];
        const tracePointsY = [];

        groupNames.forEach(grp => {
            const vals = groupsFC[grp];
            const mean = getMean(vals);
            const sem = calculateStandardError(vals);
            
            xData.push(grp);
            yMean.push(mean);
            yError.push(sem);
            
            vals.forEach(v => {
                tracePointsX.push(grp);
                tracePointsY.push(v);
            });
        });

        const traceBar = {
            x: xData,
            y: yMean,
            type: 'bar',
            name: 'Mean Â± SEM (FC)',
            marker: { color: 'rgba(52, 152, 219, 0.7)', line: { width: 1 } },
            error_y: { type: 'data', array: yError, visible: true, color: '#2c3e50', thickness: 1.5, width: 5 }
        };

        const tracePoints = {
            x: tracePointsX,
            y: tracePointsY,
            mode: 'markers',
            type: 'scatter',
            name: 'Replicates',
            marker: { color: '#2c3e50', size: 8, symbol: 'circle-open', opacity: 0.8 },
            hoverinfo: 'y'
        };

        const layout = {
            title: `Relative Expression: ${targetGene}`,
            yaxis: { title: 'Fold Change (2^-Î”Î”Ct)', zeroline: true },
            xaxis: { title: 'Group', categoryorder: 'array', categoryarray: groupNames },
            annotations: annotations, 
            showlegend: false,
            template: 'plotly_white',
            margin: { t: 50, b: 50, l: 60, r: 20 }
        };

        Plotly.newPlot('plotlyChart', [traceBar, tracePoints], layout, {responsive: true});
    }

    function calculateStandardError(values) {
        if (!values || values.length < 2) return 0;
        const mean = getMean(values);
        const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / (values.length - 1);
        return Math.sqrt(variance) / Math.sqrt(values.length);
    }

    function getStars(p) {
        if (p < 0.001) return '***';
        if (p < 0.01) return '**';
        if (p < 0.05) return '*';
        return 'ns';
    }

    // --- 4. å·¥å…·å‡½æ•¸ ---
    function getMean(arr) { 
        if(!arr || arr.length===0) return 0;
        return arr.reduce((a,b)=>a+b,0) / arr.length; 
    }

    // ä¿®æ”¹å¾Œï¼šä½¿ç”¨ Welch's t-test (ä¸å‡è¨­è®Šç•°æ•¸ç›¸ç­‰)
    function twoSampleTtest(sample1, sample2) {
        const n1 = sample1.length;
        const n2 = sample2.length;
        // åŸºæœ¬é˜²å‘†ï¼šæ¨£æœ¬æ•¸ä¸è¶³ 2 ç„¡æ³•è¨ˆç®—è®Šç•°æ•¸
        if(n1 < 2 || n2 < 2) return 1.0; 

        const m1 = jStat.mean(sample1);
        const m2 = jStat.mean(sample2);
        const v1 = jStat.variance(sample1); // æ¨£æœ¬è®Šç•°æ•¸ (Sample Variance)
        const v2 = jStat.variance(sample2);

        // --- å·®ç•°é»é–‹å§‹ ---
        
        // 1. è¨ˆç®—æ¨™æº–èª¤ (Standard Error)
        // Welch's t-test ä¸åˆä½µè®Šç•°æ•¸ (No Pooled Variance)ï¼Œè€Œæ˜¯å„è‡ªè¨ˆç®—
        const vn1 = v1 / n1; 
        const vn2 = v2 / n2; 
        const se = Math.sqrt(vn1 + vn2);
        
        // å¦‚æœæ¨™æº–èª¤ç‚º 0 (å…©çµ„æ•¸æ“šå®Œå…¨ä¸€æ¨£ä¸”ç„¡è®Šç•°)ï¼Œè¦–ç‚ºç„¡é¡¯è‘—å·®ç•°
        if (se === 0) return (m1 === m2) ? 1.0 : 0.0;

        // 2. è¨ˆç®— t-statistic
        const tStat = (m1 - m2) / se;

        // 3. è¨ˆç®—è‡ªç”±åº¦ (Degrees of Freedom)
        // ä½¿ç”¨ Welch-Satterthwaite å…¬å¼æ ¡æ­£è‡ªç”±åº¦
        // df å¯èƒ½æœƒè®Šæˆå°æ•¸ï¼Œé€™æ˜¯æ­£å¸¸çš„
        const num = Math.pow(vn1 + vn2, 2); // åˆ†å­
        const den = (Math.pow(vn1, 2) / (n1 - 1)) + (Math.pow(vn2, 2) / (n2 - 1)); // åˆ†æ¯
        const df = num / den;

        // --- å·®ç•°é»çµæŸ ---

        // 4. è¨ˆç®— P-value (é›™å°¾æª¢å®š Two-tailed)
        // jStat æ”¯æ´å°æ•¸é»çš„è‡ªç”±åº¦ï¼Œæ‰€ä»¥ç›´æ¥ä»£å…¥å³å¯
        const p = (1 - jStat.studentt.cdf(Math.abs(tStat), df)) * 2;
        
        return p;
    }

    function exportCSV() {
        let csv = "\uFEFFGene,Sample,Raw Ct Values,Mean Ct,Delta Ct,ddCt,Fold Change\n";
        const rows = document.querySelectorAll('#resultTable tbody tr');
        rows.forEach(tr => {
            const cells = tr.querySelectorAll('td');
            if (cells.length === 0) return;
            const gene = cells[0].innerText;
            const sample = cells[1].innerText;
            const meanCt = cells[2].innerText;
            const deltaCt = cells[3].innerText;
            const ddCt = cells[4].innerText;
            const foldChange = cells[5].innerText;
            let rawCtsString = "";
            if (GLOBAL_DATA[sample] && GLOBAL_DATA[sample][gene]) {
                rawCtsString = GLOBAL_DATA[sample][gene].join("; ");
            }
            const rowData = [`"${gene}"`, `"${sample}"`, `"${rawCtsString}"`, `"${meanCt}"`, `"${deltaCt}"`, `"${ddCt}"`, `"${foldChange}"`];
            csv += rowData.join(",") + "\n";
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "qpcr_results.csv"; 
        link.click();
    }
    
    // åŒ¯å‡ºç•¶å‰åŸºå› çµ±è¨ˆ
    function exportStatsCSV() {
        const geneName = document.getElementById('plotGeneSelect').value;
        if (!CURRENT_STATS_EXPORT_DATA || CURRENT_STATS_EXPORT_DATA.length === 0) {
            alert(t('alertNoStats'));
            return;
        }
        
        const filename = `qpcr_stats_${geneName}_report.csv`;
        downloadStatsCSV(CURRENT_STATS_EXPORT_DATA, filename);
    }

    // åŒ¯å‡ºæ‰€æœ‰åŸºå› çµ±è¨ˆ
    function exportAllStatsCSV() {
        const refGene = document.getElementById('refGeneSelect').value;
        let allStats = [];

        GENE_LIST.forEach(gene => {
            if (gene === refGene) return; 

            const analysis = calculateGeneStats(gene);
            
            if (analysis.error) {
                console.warn(`Skipping ${gene}: ${analysis.error}`);
            } else {
                // å°‡è©²åŸºå› çš„çµæœåŠ å…¥ç¸½è¡¨ï¼Œä¸¦æ¨™è¨˜ targetGene å’Œ anovaP
                const taggedResults = analysis.results.map(r => ({ 
                    ...r, 
                    targetGene: gene,
                    anovaP: analysis.anovaP
                }));
                allStats = allStats.concat(taggedResults);
            }
        });

        if (allStats.length === 0) {
            alert(t('alertNoStats'));
            return;
        }

        downloadStatsCSV(allStats, "qpcr_stats_ALL_GENES_report.csv");
    }

    // é€šç”¨ CSV ä¸‹è¼‰å‡½æ•¸ (æ–°å¢ ANOVA_P æ¬„ä½)
    function downloadStatsCSV(data, filename) {
        let csv = "\uFEFFTarget_Gene,ANOVA_P_Value,Comparison,Group_N,Control_N,Mean_FC_Exp,Mean_FC_Ctrl,SEM_Exp,SEM_Ctrl,P_Value_Raw,P_Value_Adj,Significance\n";
        
        data.forEach(d => {
            const anovaStr = (d.anovaP !== null && d.anovaP !== undefined) ? d.anovaP.toFixed(8) : "N/A";
            const row = [
                `"${d.targetGene}"`,
                anovaStr,
                `"${d.comparison}"`,
                d.nExp,
                d.nCtrl,
                d.meanFC.toFixed(4),
                d.ctrlMeanFC.toFixed(4),
                d.semFC.toFixed(4),
                d.ctrlSemFC.toFixed(4),
                d.pRaw.toFixed(8),
                d.pAdj.toFixed(8),
                `"${d.sig}"`
            ];
            csv += row.join(",") + "\n";
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
    }

    function loadDemoData() {
        document.getElementById('geneCountInput').value = 3;
        generateGeneBlocks();
        
        const samples = "WT-1\nWT-2\nWT-3\nTreatA-1\nTreatA-2\nTreatA-3\nTreatB-1\nTreatB-2\nTreatB-3";
        const gapdhCt = "22.5\n22.4\n22.6\n22.5\n22.8\n22.7\n22.6\n22.5\n22.8";
        const il6Ct = "30.5\n30.4\n30.6\n27.5\n27.1\n27.9\n28.5\n28.9\n28.2";
        const il17Ct = "30.7\n30.2\n30.4\n28.5\n28.8\n28.2\n29.1\n28.8\n28.3";

        setTimeout(() => {
            const blocks = document.querySelectorAll('.gene-block');
            if(blocks.length >= 3) {
                blocks[0].querySelector('.gene-name-input').value = "GAPDH";
                blocks[0].querySelector('.samples-input').value = samples;
                blocks[0].querySelector('.cts-input').value = gapdhCt;

                blocks[1].querySelector('.gene-name-input').value = "IL6";
                blocks[1].querySelector('.samples-input').value = samples;
                blocks[1].querySelector('.cts-input').value = il6Ct;

                blocks[2].querySelector('.gene-name-input').value = "IL17";
                blocks[2].querySelector('.samples-input').value = samples;
                blocks[2].querySelector('.cts-input').value = il17Ct;
            }
            document.getElementById('controlKeyword').value = "WT";
            alert(t('demoLoaded'));
        }, 100);
    }
</script>
</body>
</html>